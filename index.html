<?php
// Start the session at the very beginning
session_start();
// Database configuration - NEW DATABASE NAME
$host = 'sql205.infinityfree.com';
$dbname = 'if0_40340582_stii_inventory';
$username = 'if0_40340582';
$password = 'neverdie0514';
// First, connect without selecting database to check if it exists
try {
    $pdo_temp = new PDO("mysql:host=$host", $username, $password);
    $pdo_temp->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    // Check if database exists using a prepared statement
    $stmt = $pdo_temp->prepare("SELECT SCHEMA_NAME FROM INFORMATION_SCHEMA.SCHEMATA WHERE SCHEMA_NAME = ?");
    $stmt->execute([$dbname]);
    $databaseExists = $stmt->fetch(PDO::FETCH_ASSOC);
    if (!$databaseExists) {
        // Create database
        $pdo_temp->exec("CREATE DATABASE $dbname");
        $databaseCreated = true;
    }
    // Now connect to the specific database
    $pdo = new PDO("mysql:host=$host;dbname=$dbname", $username, $password);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
} catch (PDOException $e) {
    die("Could not connect to the database: " . $e->getMessage());
}
// --- USER MANAGEMENT & AUTHENTICATION ---
// Create users table if it doesn't exist
$createUserTableQuery = "
CREATE TABLE IF NOT EXISTS users (
    id INT(11) AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(100) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    role ENUM('admin', 'staff') NOT NULL DEFAULT 'staff',
    date_created TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)";
$pdo->exec($createUserTableQuery);
// Check if there are any users, if not, create a default admin user
$userCheck = $pdo->query("SELECT id FROM users LIMIT 1");
if ($userCheck->rowCount() == 0) {
    $defaultUsername = 'admin';
    $defaultPassword = 'password123'; // Using a slightly more complex default
    $hashedPassword = password_hash($defaultPassword, PASSWORD_DEFAULT);
    $adminStmt = $pdo->prepare("INSERT INTO users (username, password, role) VALUES (?, ?, 'admin')");
    $adminStmt->execute([$defaultUsername, $hashedPassword]);
    $defaultAdminCreated = "Default admin user created. Username: <strong>$defaultUsername</strong>, Password: <strong>$defaultPassword</strong>. Please change this password immediately from the Profile page after logging in.";
}
// Handle Login
if (isset($_POST['login'])) {
    $username = trim($_POST['username']);
    $password = $_POST['password'];
    $stmt = $pdo->prepare("SELECT * FROM users WHERE username = ?");
    $stmt->execute([$username]);
    $user = $stmt->fetch(PDO::FETCH_ASSOC);
    if ($user && password_verify($password, $user['password'])) {
        $_SESSION['user_id'] = $user['id'];
        $_SESSION['username'] = $user['username'];
        $_SESSION['role'] = $user['role'];
        header("Location: ?page=dashboard");
        exit;
    } else {
        $login_error = "Invalid username or password.";
    }
}
// Handle Logout
if (isset($_GET['action']) && $_GET['action'] == 'logout') {
    session_unset();
    session_destroy();
    header("Location: ?page=login&logged_out=true");
    exit;
}
// Redirect to login if not logged in, except for the login page itself
$current_page = isset($_GET['page']) ? $_GET['page'] : (isset($_SESSION['user_id']) ? 'dashboard' : 'login');
if (!isset($_SESSION['user_id']) && $current_page !== 'login') {
    header("Location: ?page=login");
    exit;
}
// --- END USER MANAGEMENT ---
// Check and update database structure
try {
    // Check if property_number column exists in inventory table
    $checkColumn = $pdo->query("SHOW COLUMNS FROM inventory LIKE 'property_number'");
    if ($checkColumn->rowCount() == 0) {
        $pdo->exec("ALTER TABLE inventory ADD COLUMN property_number VARCHAR(100) NULL");
    }
    // Check if is_borrowable column exists
    $checkBorrowable = $pdo->query("SHOW COLUMNS FROM inventory LIKE 'is_borrowable'");
    if ($checkBorrowable->rowCount() == 0) {
        $pdo->exec("ALTER TABLE inventory ADD COLUMN is_borrowable TINYINT(1) DEFAULT 0");
    }
    // Check if item_type column exists
    $checkItemType = $pdo->query("SHOW COLUMNS FROM inventory LIKE 'item_type'");
    if ($checkItemType->rowCount() == 0) {
        $pdo->exec("ALTER TABLE inventory ADD COLUMN item_type ENUM('Consumable', 'Non-Consumable') NOT NULL DEFAULT 'Non-Consumable'");
    }
    // Check if unit column exists
    $checkUnit = $pdo->query("SHOW COLUMNS FROM inventory LIKE 'unit'");
    if ($checkUnit->rowCount() == 0) {
        $pdo->exec("ALTER TABLE inventory ADD COLUMN unit VARCHAR(50) NOT NULL DEFAULT 'pcs'");
    }
    // NEW: Check if floor_number and room_number columns exist in inventory table
    $checkFloor = $pdo->query("SHOW COLUMNS FROM inventory LIKE 'floor_number'");
    if ($checkFloor->rowCount() == 0) {
        $pdo->exec("ALTER TABLE inventory ADD COLUMN floor_number TINYINT NULL");
    }
    $checkRoom = $pdo->query("SHOW COLUMNS FROM inventory LIKE 'room_number'");
    if ($checkRoom->rowCount() == 0) {
        $pdo->exec("ALTER TABLE inventory ADD COLUMN room_number VARCHAR(50) NULL");
    }
} catch (Exception $e) {
    // Table might not exist, it will be created fresh by the next block
}
// Create tables if they don't exist
// UPDATED: For non-consumable items, now includes floor_number and room_number for grouping
$createTableQuery = "
CREATE TABLE IF NOT EXISTS inventory (
    id INT(11) AUTO_INCREMENT PRIMARY KEY,
    property_number VARCHAR(100) NULL,
    item_name VARCHAR(255) NOT NULL,
    item_type ENUM('Consumable', 'Non-Consumable') NOT NULL DEFAULT 'Non-Consumable',
    unit VARCHAR(50) NOT NULL DEFAULT 'pcs',
    location ENUM('STII Main', 'Sanito Campus', 'Eco-farm Campus') NULL,
    floor_number TINYINT NULL,
    room_number VARCHAR(50) NULL,
    classification ENUM('Electronics and Equipments', 'Office Supplies', 'Sports', 'Drums and Bugles', 'Furniture') NOT NULL,
    quantity INT(11) NOT NULL DEFAULT 0,
    price DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    date_added DATE NOT NULL,
    status ENUM('Available', 'Out of Stock') DEFAULT 'Available',
    is_borrowable TINYINT(1) DEFAULT 0,
    last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_location_room (location, floor_number, room_number),
    INDEX idx_item_location (item_name, location, floor_number, room_number)
)";
$pdo->exec($createTableQuery);
// NEW: Create inventory_units table for individual unit tracking
$createUnitsTableQuery = "
CREATE TABLE IF NOT EXISTS inventory_units (
    id INT(11) AUTO_INCREMENT PRIMARY KEY,
    inventory_id INT(11) NOT NULL,
    unit_property_number VARCHAR(100) NOT NULL UNIQUE,
    unit_status ENUM('Available', 'Issued', 'Borrowed', 'Under Maintenance', 'For Replacement', 'Disposed') DEFAULT 'Available',
    unit_condition ENUM('Excellent', 'Good', 'Fair', 'Poor', 'Defective') DEFAULT 'Good',
    date_added TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    notes TEXT,
    FOREIGN KEY (inventory_id) REFERENCES inventory(id) ON DELETE CASCADE
)";
$pdo->exec($createUnitsTableQuery);
// NEW: Create department_issue table for issuing items to departments
$createDepartmentIssueTableQuery = "
CREATE TABLE IF NOT EXISTS department_issue (
    id INT(11) AUTO_INCREMENT PRIMARY KEY,
    unit_id INT(11) NOT NULL,
    department VARCHAR(255) NOT NULL,
    location ENUM('STII Main', 'Sanito Campus', 'Eco-farm Campus') NOT NULL,
    floor_number TINYINT NULL,
    room_number VARCHAR(50) NULL,
    issued_to VARCHAR(255) NOT NULL,
    issue_date DATE NOT NULL,
    issued_by VARCHAR(100) NOT NULL,
    notes TEXT,
    date_recorded TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (unit_id) REFERENCES inventory_units(id) ON DELETE CASCADE
)";
$pdo->exec($createDepartmentIssueTableQuery);
// NEW: Create inventory_unit_functionality_checks table for functionality checks on individual units
$createUnitFunctionalityChecksQuery = "
CREATE TABLE IF NOT EXISTS inventory_unit_functionality_checks (
    id INT(11) AUTO_INCREMENT PRIMARY KEY,
    unit_id INT(11) NOT NULL,
    check_date DATE NOT NULL,
    checked_by VARCHAR(255) NOT NULL,
    functionality_status ENUM('Fully Functional', 'Partially Functional', 'Needs Maintenance', 'Needs Replacement', 'Not Functional') NOT NULL,
    condition_status ENUM('Excellent', 'Good', 'Fair', 'Poor', 'Defective') NOT NULL,
    maintenance_required TEXT,
    replacement_recommended TINYINT(1) DEFAULT 0,
    estimated_maintenance_cost DECIMAL(10,2) DEFAULT 0.00,
    next_check_date DATE NULL,
    notes TEXT,
    date_recorded TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (unit_id) REFERENCES inventory_units(id) ON DELETE CASCADE
)";
$pdo->exec($createUnitFunctionalityChecksQuery);
// Check if inventory_batch_history table exists and create it if not
try {
    $pdo->query("SELECT 1 FROM inventory_batch_history LIMIT 1");
} catch (Exception $e) {
    // Table doesn't exist, create it
    $createBatchHistoryQuery = "
    CREATE TABLE inventory_batch_history (
        id INT(11) AUTO_INCREMENT PRIMARY KEY,
        inventory_id INT(11) NOT NULL,
        batch_quantity INT(11) NOT NULL,
        batch_price DECIMAL(10,2) NOT NULL,
        batch_date DATE NOT NULL,
        added_by VARCHAR(100) DEFAULT 'System',
        notes TEXT,
        date_recorded TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (inventory_id) REFERENCES inventory(id) ON DELETE CASCADE
    )";
    $pdo->exec($createBatchHistoryQuery);
}
// Check if inventory_release_history table exists and create it if not
try {
    $pdo->query("SELECT 1 FROM inventory_release_history LIMIT 1");
} catch (Exception $e) {
    // Table doesn't exist, create it
    $createReleaseHistoryQuery = "
    CREATE TABLE inventory_release_history (
        id INT(11) AUTO_INCREMENT PRIMARY KEY,
        inventory_id INT(11) NOT NULL,
        release_quantity INT(11) NOT NULL,
        release_date DATE NOT NULL,
        released_to VARCHAR(255) NOT NULL,
        purpose TEXT,
        date_recorded TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (inventory_id) REFERENCES inventory(id) ON DELETE CASCADE
    )";
    $pdo->exec($createReleaseHistoryQuery);
}
// Check if inventory_borrowing table exists and create it if not
try {
    $pdo->query("SELECT 1 FROM inventory_borrowing LIMIT 1");
} catch (Exception $e) {
    // Table doesn't exist, create it
    $createBorrowingQuery = "
    CREATE TABLE inventory_borrowing (
        id INT(11) AUTO_INCREMENT PRIMARY KEY,
        inventory_id INT(11) NOT NULL,
        borrower_name VARCHAR(255) NOT NULL,
        borrower_department VARCHAR(255) NOT NULL,
        borrower_contact VARCHAR(100),
        quantity_borrowed INT(11) NOT NULL,
        borrow_date DATE NOT NULL,
        expected_return_date DATE NOT NULL,
        actual_return_date DATE NULL,
        condition_before ENUM('Excellent', 'Good', 'Fair', 'Poor', 'Defective') DEFAULT 'Good',
        condition_after ENUM('Excellent', 'Good', 'Fair', 'Poor', 'Defective') NULL,
        status ENUM('Borrowed', 'Returned', 'Overdue', 'Damaged') DEFAULT 'Borrowed',
        notes TEXT,
        damage_notes TEXT,
        date_recorded TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (inventory_id) REFERENCES inventory(id) ON DELETE CASCADE
    )";
    $pdo->exec($createBorrowingQuery);
}
// NEW: Create inventory_borrowing_units table to track individual borrowed units
$createBorrowingUnitsQuery = "
CREATE TABLE IF NOT EXISTS inventory_borrowing_units (
    id INT(11) AUTO_INCREMENT PRIMARY KEY,
    borrowing_id INT(11) NOT NULL,
    unit_id INT(11) NOT NULL,
    date_recorded TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (borrowing_id) REFERENCES inventory_borrowing(id) ON DELETE CASCADE,
    FOREIGN KEY (unit_id) REFERENCES inventory_units(id) ON DELETE CASCADE
)";
$pdo->exec($createBorrowingUnitsQuery);
// Helper function to display location
function formatLocation($item) {
    if (empty($item['location'])) {
        return 'Not Issued';
    }
    $location = htmlspecialchars($item['location']);
    // Add floor and room information if available
    if ($item['location'] === 'STII Main') {
        if (!empty($item['floor_number'])) {
            $location .= ' (Floor ' . htmlspecialchars($item['floor_number']);
            if (!empty($item['room_number'])) {
                $location .= ', Room ' . htmlspecialchars($item['room_number']);
            }
            $location .= ')';
        } else if (!empty($item['room_number'])) {
            $location .= ' (Room ' . htmlspecialchars($item['room_number']) . ')';
        }
    } else {
        if (!empty($item['room_number'])) {
            $location .= ' (Room ' . htmlspecialchars($item['room_number']) . ')';
        }
    }
    return $location;
}
// NEW: Helper function to get unit location from department_issue
function getUnitLocation($pdo, $unit_id) {
    $stmt = $pdo->prepare("
        SELECT di.location, di.floor_number, di.room_number, di.department, di.issued_to
        FROM department_issue di
        WHERE di.unit_id = ?
        ORDER BY di.issue_date DESC
        LIMIT 1
    ");
    $stmt->execute([$unit_id]);
    $issue = $stmt->fetch(PDO::FETCH_ASSOC);
    if ($issue) {
        $location = htmlspecialchars($issue['location']);
        if ($issue['location'] === 'STII Main') {
            if (!empty($issue['floor_number'])) {
                $location .= ' (Floor ' . htmlspecialchars($issue['floor_number']);
                if (!empty($issue['room_number'])) {
                    $location .= ', Room ' . htmlspecialchars($issue['room_number']);
                }
                $location .= ')';
            } else if (!empty($issue['room_number'])) {
                $location .= ' (Room ' . htmlspecialchars($issue['room_number']) . ')';
            }
        } else {
            if (!empty($issue['room_number'])) {
                $location .= ' (Room ' . htmlspecialchars($issue['room_number']) . ')';
            }
        }
        return $location . ' - ' . htmlspecialchars($issue['department']) . ' (' . htmlspecialchars($issue['issued_to']) . ')';
    }
    return 'Not Issued';
}
// NEW: Helper function to generate property numbers with sequential continuation
function generatePropertyNumbers($basePropertyNumber, $quantity, $pdo, $inventory_id = null) {
    $propertyNumbers = [];
    if (empty($basePropertyNumber)) {
        // Generate a base property number if none provided
        $basePropertyNumber = 'STII-' . date('Y') . '-' . substr(md5(uniqid()), 0, 6);
    }
    // If we have an inventory_id, find the last sequence number used
    $lastSequence = 0;
    if ($inventory_id) {
        $stmt = $pdo->prepare("SELECT unit_property_number FROM inventory_units WHERE inventory_id = ? ORDER BY unit_property_number DESC LIMIT 1");
        $stmt->execute([$inventory_id]);
        $lastUnit = $stmt->fetch(PDO::FETCH_ASSOC);
   
        if ($lastUnit) {
            $lastPropertyNumber = $lastUnit['unit_property_number'];
            // Extract the sequence number from the last property number
            // Format: BASE-001, BASE-002, etc.
            $pattern = '/-' . preg_quote($basePropertyNumber, '/') . '-(\d+)$/';
            if (preg_match($pattern, $lastPropertyNumber, $matches)) {
                $lastSequence = (int)$matches[1];
            } else {
                // Try alternative pattern: BASE-001 (without the base repeated)
                $pattern = '/-(\d+)$/';
                if (preg_match($pattern, $lastPropertyNumber, $matches)) {
                    $lastSequence = (int)$matches[1];
                } else {
                    // Check if the last property number is exactly the base (no sequence)
                    if ($lastPropertyNumber === $basePropertyNumber) {
                        $lastSequence = 1; // Start sequencing from 002
                    }
                }
            }
        }
    }
    // Generate new property numbers continuing from the last sequence
    for ($i = 1; $i <= $quantity; $i++) {
        $sequence = $lastSequence + $i;
        if ($quantity == 1 && $lastSequence == 0) {
            // Single item, no previous sequence
            $propertyNumbers[] = $basePropertyNumber;
        } else {
            $propertyNumbers[] = $basePropertyNumber . '-' . str_pad($sequence, 3, '0', STR_PAD_LEFT);
        }
    }
    return $propertyNumbers;
}
// NEW: Function to get or create inventory group for non-consumable items
function getOrCreateInventoryGroup($pdo, $item_name, $item_type, $unit, $location, $floor_number, $room_number, $classification, $price, $date_added, $is_borrowable = 0, $property_number = null) {
    // For consumable items or non-consumable without specific location, use the main entry
    if ($item_type === 'Consumable' || empty($location)) {
        // Check if item already exists (same name, unit, classification, type, and no specific location)
        $checkQuery = "SELECT id FROM inventory WHERE item_name = ? AND unit = ? AND classification = ? AND item_type = ? AND location IS NULL";
        $checkParams = [$item_name, $unit, $classification, $item_type];
    } else {
        // For non-consumable items with specific location, check for existing group
        $checkQuery = "SELECT id FROM inventory WHERE item_name = ? AND unit = ? AND classification = ? AND item_type = ? AND location = ? AND floor_number <=> ? AND room_number <=> ?";
        $checkParams = [$item_name, $unit, $classification, $item_type, $location, $floor_number, $room_number];
    }
    $checkStmt = $pdo->prepare($checkQuery);
    $checkStmt->execute($checkParams);
    $existingItem = $checkStmt->fetch(PDO::FETCH_ASSOC);
    if ($existingItem) {
        return $existingItem['id'];
    } else {
        // Create new inventory group
        $insertStmt = $pdo->prepare("INSERT INTO inventory (property_number, item_name, item_type, unit, location, floor_number, room_number, classification, quantity, price, date_added, status, is_borrowable) VALUES (?, ?, ?, ?, ?, ?, ?, ?, 0, ?, ?, 'Available', ?)");
        $insertStmt->execute([$property_number, $item_name, $item_type, $unit, $location, $floor_number, $room_number, $classification, $price, $date_added, $is_borrowable]);
        return $pdo->lastInsertId();
    }
}
// NEW: Function to get item details with units
function getItemDetails($pdo, $item_id) {
    $stmt = $pdo->prepare("
        SELECT i.*,
               COUNT(u.id) as total_units,
               SUM(CASE WHEN u.unit_status = 'Available' THEN 1 ELSE 0 END) as available_units
        FROM inventory i
        LEFT JOIN inventory_units u ON i.id = u.inventory_id
        WHERE i.id = ?
        GROUP BY i.id
    ");
    $stmt->execute([$item_id]);
    $item = $stmt->fetch(PDO::FETCH_ASSOC);
    if ($item) {
        $units_stmt = $pdo->prepare("
            SELECT u.*,
                   (SELECT COUNT(*) FROM inventory_unit_functionality_checks fc WHERE fc.unit_id = u.id) as check_count,
                   (SELECT check_date FROM inventory_unit_functionality_checks fc WHERE fc.unit_id = u.id ORDER BY check_date DESC LIMIT 1) as last_check_date
            FROM inventory_units u
            WHERE u.inventory_id = ?
            ORDER BY u.unit_property_number
        ");
        $units_stmt->execute([$item_id]);
        $item['units'] = $units_stmt->fetchAll(PDO::FETCH_ASSOC);
   
        // Get functionality check history for each unit
        foreach ($item['units'] as &$unit) {
            $checks_stmt = $pdo->prepare("SELECT * FROM inventory_unit_functionality_checks WHERE unit_id = ? ORDER BY check_date DESC");
            $checks_stmt->execute([$unit['id']]);
            $unit['functionality_checks'] = $checks_stmt->fetchAll(PDO::FETCH_ASSOC);
       
            // Get current location for each unit
            $unit['current_location'] = getUnitLocation($pdo, $unit['id']);
        }
    }
    return $item;
}
// NEW: Function to get functionality check details
function getFunctionalityCheckDetails($pdo, $check_id) {
    $stmt = $pdo->prepare("
        SELECT fc.*, u.unit_property_number, i.item_name, i.classification
        FROM inventory_unit_functionality_checks fc
        JOIN inventory_units u ON fc.unit_id = u.id
        JOIN inventory i ON u.inventory_id = i.id
        WHERE fc.id = ?
    ");
    $stmt->execute([$check_id]);
    return $stmt->fetch(PDO::FETCH_ASSOC);
}
// NEW: Function to get department issue details
function getDepartmentIssueDetails($pdo, $issue_id) {
    $stmt = $pdo->prepare("
        SELECT di.*, u.unit_property_number, i.item_name, i.classification
        FROM department_issue di
        JOIN inventory_units u ON di.unit_id = u.id
        JOIN inventory i ON u.inventory_id = i.id
        WHERE di.id = ?
    ");
    $stmt->execute([$issue_id]);
    return $stmt->fetch(PDO::FETCH_ASSOC);
}
// NEW: Function to find main unissued inventory group for an item
function findMainUnissuedGroup($pdo, $item_name, $classification, $unit, $item_type) {
    $stmt = $pdo->prepare("
        SELECT id, property_number, quantity
        FROM inventory
        WHERE item_name = ?
        AND classification = ?
        AND unit = ?
        AND item_type = ?
        AND location IS NULL
    ");
    $stmt->execute([$item_name, $classification, $unit, $item_type]);
    return $stmt->fetch(PDO::FETCH_ASSOC);
}
// Handle Report Generation and Download
if (isset($_GET['generate_report'])) {
    $report_type = $_GET['report_type'] ?? 'inventory_summary';
    $report_start_date = $_GET['report_start_date'] ?? date('Y-m-01');
    $report_end_date = $_GET['report_end_date'] ?? date('Y-m-d');
    $report_location = $_GET['report_location'] ?? '';
    $report_classification = $_GET['report_classification'] ?? '';
    $report_item_type = $_GET['report_item_type'] ?? '';
    $report_floor_number = $_GET['report_floor_number'] ?? '';
    $report_room_number = $_GET['report_room_number'] ?? '';
    $action = $_GET['action'] ?? 'view';
    if ($action === 'download') {
        // Generate PDF for download
        generatePDFReport($pdo, $report_type, [
            'start_date' => $report_start_date,
            'end_date' => $report_end_date,
            'location' => $report_location,
            'classification' => $report_classification,
            'item_type' => $report_item_type,
            'floor_number' => $report_floor_number,
            'room_number' => $report_room_number
        ]);
        exit;
    }
    // Common report filters
    $filter_params = [
        'start_date' => $report_start_date,
        'end_date' => $report_end_date,
        'location' => $report_location,
        'classification' => $report_classification,
        'item_type' => $report_item_type,
        'floor_number' => $report_floor_number,
        'room_number' => $report_room_number
    ];
    // Both 'view' and 'download' will generate the same HTML content
    switch ($report_type) {
        case 'inventory_summary':
            generateInventorySummaryReport($pdo, $filter_params, $action === 'download');
            break;
        case 'movement_history':
            generateMovementHistoryReport($pdo, $filter_params, $action === 'download');
            break;
        case 'batch_history':
            generateBatchHistoryReport($pdo, $filter_params, $action === 'download');
            break;
        case 'release_history':
            generateReleaseHistoryReport($pdo, $filter_params, $action === 'download');
            break;
        case 'borrowing_history':
            generateBorrowingHistoryReport($pdo, $filter_params, $action === 'download');
            break;
        case 'functionality_check_report':
            generateFunctionalityCheckReport($pdo, $filter_params, $action === 'download');
            break;
        case 'low_stock':
            generateLowStockReport($pdo, $filter_params, $action === 'download');
            break;
        case 'unit_tracking': // NEW: Unit tracking report
            generateUnitTrackingReport($pdo, $filter_params, $action === 'download');
            break;
        case 'consumable_stock_movement': // NEW: Consumable Stock Movement Report
            generateConsumableStockMovementReport($pdo, $filter_params, $action === 'download');
            break;
        case 'department_issue_report': // NEW: Department Issue Report
            generateDepartmentIssueReport($pdo, $filter_params, $action === 'download');
            break;
    }
    exit;
}
// NEW: PDF Report Generation Function
function generatePDFReport($pdo, $report_type, $filters) {
    // For PDF generation, we would typically use a library like TCPDF or DomPDF
    // Since we can't include external libraries here, we'll create a basic HTML that can be converted to PDF
    // In a real implementation, you would use a proper PDF library
    $html_content = generateReportHTML($pdo, $report_type, $filters);
    // Set headers for PDF download
    header('Content-Type: application/pdf');
    header('Content-Disposition: attachment; filename="inventory_report_' . $report_type . '_' . date('Y-m-d') . '.pdf"');
    // In a real implementation, you would convert HTML to PDF here
    // For now, we'll output HTML with PDF styling
    echo $html_content;
}
// NEW: Generate HTML for PDF reports
function generateReportHTML($pdo, $report_type, $filters) {
    ob_start();
    switch ($report_type) {
        case 'inventory_summary':
            generateInventorySummaryReport($pdo, $filters, true);
            break;
        case 'movement_history':
            generateMovementHistoryReport($pdo, $filters, true);
            break;
        case 'batch_history':
            generateBatchHistoryReport($pdo, $filters, true);
            break;
        case 'release_history':
            generateReleaseHistoryReport($pdo, $filters, true);
            break;
        case 'borrowing_history':
            generateBorrowingHistoryReport($pdo, $filters, true);
            break;
        case 'functionality_check_report':
            generateFunctionalityCheckReport($pdo, $filters, true);
            break;
        case 'low_stock':
            generateLowStockReport($pdo, $filters, true);
            break;
        case 'unit_tracking':
            generateUnitTrackingReport($pdo, $filters, true);
            break;
        case 'consumable_stock_movement':
            generateConsumableStockMovementReport($pdo, $filters, true);
            break;
        case 'department_issue_report':
            generateDepartmentIssueReport($pdo, $filters, true);
            break;
    }
    $html = ob_get_clean();
    return $html;
}
// NEW: Department Issue Report Function
function generateDepartmentIssueReport($pdo, $filters, $isDownload = false) {
    $start_date = $filters['start_date'];
    $end_date = $filters['end_date'];
    $query = "SELECT di.*, u.unit_property_number, i.item_name, i.classification
              FROM department_issue di
              JOIN inventory_units u ON di.unit_id = u.id
              JOIN inventory i ON u.inventory_id = i.id
              WHERE di.issue_date BETWEEN ? AND ?";
    $params = [$start_date, $end_date];
    // Apply filters
    if (!empty($filters['location'])) {
        $query .= " AND di.location = ?";
        $params[] = $filters['location'];
    }
    if (!empty($filters['classification'])) {
        $query .= " AND i.classification = ?";
        $params[] = $filters['classification'];
    }
    if (!empty($filters['floor_number'])) {
        $query .= " AND di.floor_number = ?";
        $params[] = $filters['floor_number'];
    }
    if (!empty($filters['room_number'])) {
        $query .= " AND di.room_number LIKE ?";
        $params[] = '%' . $filters['room_number'] . '%';
    }
    $query .= " ORDER BY di.issue_date DESC";
    $stmt = $pdo->prepare($query);
    $stmt->execute($params);
    $department_issues = $stmt->fetchAll(PDO::FETCH_ASSOC);
    displayReportHeader("Department Issue Report", $filters['start_date'], $filters['end_date'], $filters['location'], $filters['classification'], $isDownload);
    ?>
    <table border="1" cellpadding="8" cellspacing="0" width="100%" style="border-collapse: collapse;">
        <thead>
            <tr style="background-color: #8e44ad; color: white;">
                <th>Issue Date</th>
                <th>Property Number</th>
                <th>Item Name</th>
                <th>Classification</th>
                <th>Department</th>
                <th>Location</th>
                <th>Floor/Room</th>
                <th>Issued To</th>
                <th>Issued By</th>
                <th>Notes</th>
            </tr>
        </thead>
        <tbody>
            <?php foreach ($department_issues as $issue):
                $location_details = htmlspecialchars($issue['location']);
                if ($issue['location'] === 'STII Main') {
                    if (!empty($issue['floor_number'])) {
                        $location_details .= ' (Floor ' . htmlspecialchars($issue['floor_number']);
                        if (!empty($issue['room_number'])) {
                            $location_details .= ', Room ' . htmlspecialchars($issue['room_number']);
                        }
                        $location_details .= ')';
                    } else if (!empty($issue['room_number'])) {
                        $location_details .= ' (Room ' . htmlspecialchars($issue['room_number']) . ')';
                    }
                } else {
                    if (!empty($issue['room_number'])) {
                        $location_details .= ' (Room ' . htmlspecialchars($issue['room_number']) . ')';
                    }
                }
            ?>
            <tr>
                <td><?php echo date('M j, Y', strtotime($issue['issue_date'])); ?></td>
                <td><strong><?php echo htmlspecialchars($issue['unit_property_number']); ?></strong></td>
                <td><?php echo htmlspecialchars($issue['item_name']); ?></td>
                <td><?php echo htmlspecialchars($issue['classification']); ?></td>
                <td><?php echo htmlspecialchars($issue['department']); ?></td>
                <td><?php echo htmlspecialchars($issue['location']); ?></td>
                <td><?php echo $location_details; ?></td>
                <td><?php echo htmlspecialchars($issue['issued_to']); ?></td>
                <td><?php echo htmlspecialchars($issue['issued_by']); ?></td>
                <td><?php echo htmlspecialchars($issue['notes'] ?: 'N/A'); ?></td>
            </tr>
            <?php endforeach; ?>
        </tbody>
    </table>
    <?php
    displayReportFooter($isDownload);
}
// NEW: Consumable Stock Movement Report Function
function generateConsumableStockMovementReport($pdo, $filters, $isDownload = false) {
    $start_date = $filters['start_date'];
    $end_date = $filters['end_date'];
    // Get all consumable items that had activity in the date range
    $query = "SELECT i.*,
                     COALESCE((
                         SELECT SUM(bh.batch_quantity)
                         FROM inventory_batch_history bh
                         WHERE bh.inventory_id = i.id AND bh.batch_date BETWEEN ? AND ?
                     ), 0) as added_quantity,
                     COALESCE((
                         SELECT SUM(rh.release_quantity)
                         FROM inventory_release_history rh
                         WHERE rh.inventory_id = i.id AND rh.release_date BETWEEN ? AND ?
                     ), 0) as released_quantity
              FROM inventory i
              WHERE i.item_type = 'Consumable'";
    $params = [$start_date, $end_date, $start_date, $end_date];
    // Apply filters
    if (!empty($filters['location'])) {
        $query .= " AND i.location = ?";
        $params[] = $filters['location'];
    }
    if (!empty($filters['classification'])) {
        $query .= " AND i.classification = ?";
        $params[] = $filters['classification'];
    }
    $query .= " HAVING added_quantity > 0 OR released_quantity > 0
                ORDER BY i.item_name";
    $stmt = $pdo->prepare($query);
    $stmt->execute($params);
    $consumable_items = $stmt->fetchAll(PDO::FETCH_ASSOC);
    displayReportHeader("Consumable Stock Movement Report", $filters['start_date'], $filters['end_date'], $filters['location'], $filters['classification'], $isDownload);
    ?>
    <div style="margin-bottom: 20px; padding: 15px; background-color: #e8f4fd; border: 1px solid #b6d7e8; border-radius: 8px;">
        <h3 style="margin: 0 0 10px 0; color: #2c3e50;">ðŸ“Š Report Summary</h3>
        <p style="margin: 5px 0; color: #34495e;">
            This report shows stock movements for consumable items between
            <strong><?php echo date('F j, Y', strtotime($start_date)); ?></strong> and
            <strong><?php echo date('F j, Y', strtotime($end_date)); ?></strong>.
        </p>
    </div>
    <table border="1" cellpadding="8" cellspacing="0" width="100%" style="border-collapse: collapse;">
        <thead>
            <tr style="background-color: #e67e22; color: white;">
                <th>Item Name</th>
                <th>Classification</th>
                <th>Location</th>
                <th>Current Stock</th>
                <th>Unit</th>
                <th>Added Quantity</th>
                <th>Released Quantity</th>
                <th>Net Movement</th>
                <th>Current Status</th>
            </tr>
        </thead>
        <tbody>
            <?php
            $total_added = 0;
            $total_released = 0;
            $total_net_movement = 0;
       
            foreach ($consumable_items as $item):
                $net_movement = $item['added_quantity'] - $item['released_quantity'];
                $total_added += $item['added_quantity'];
                $total_released += $item['released_quantity'];
                $total_net_movement += $net_movement;
            ?>
            <tr>
                <td><strong><?php echo htmlspecialchars($item['item_name']); ?></strong></td>
                <td><?php echo htmlspecialchars($item['classification']); ?></td>
                <td><?php echo formatLocation($item); ?></td>
                <td align="center"><?php echo $item['quantity']; ?></td>
                <td align="center"><?php echo htmlspecialchars($item['unit']); ?></td>
                <td align="center" style="color: #27ae60; font-weight: bold;">
                    <?php if ($item['added_quantity'] > 0): ?>
                        +<?php echo $item['added_quantity']; ?>
                    <?php else: ?>
                        -
                    <?php endif; ?>
                </td>
                <td align="center" style="color: #e74c3c; font-weight: bold;">
                    <?php if ($item['released_quantity'] > 0): ?>
                        -<?php echo $item['released_quantity']; ?>
                    <?php else: ?>
                        -
                    <?php endif; ?>
                </td>
                <td align="center" style="font-weight: bold; <?php echo $net_movement >= 0 ? 'color: #27ae60;' : 'color: #e74c3c;'; ?>">
                    <?php echo $net_movement >= 0 ? '+' : ''; ?><?php echo $net_movement; ?>
                </td>
                <td align="center">
                    <span class="status-badge status-<?php echo strtolower(str_replace(' ', '-', $item['status'])); ?>">
                        <?php echo $item['status']; ?>
                    </span>
                </td>
            </tr>
            <?php endforeach; ?>
       
            <?php if (count($consumable_items) == 0): ?>
            <tr>
                <td colspan="9" style="text-align: center; padding: 30px; color: #7f8c8d;">
                    <h3>No consumable items found with movement in the selected date range.</h3>
                    <p>Try adjusting the date range or filters.</p>
                </td>
            </tr>
            <?php endif; ?>
        </tbody>
        <?php if (count($consumable_items) > 0): ?>
        <tfoot>
            <tr style="background-color: #f8f9fa; font-weight: bold;">
                <td colspan="5" align="right">Totals:</td>
                <td align="center" style="color: #27ae60;">+<?php echo $total_added; ?></td>
                <td align="center" style="color: #e74c3c;">-<?php echo $total_released; ?></td>
                <td align="center" style="<?php echo $total_net_movement >= 0 ? 'color: #27ae60;' : 'color: #e74c3c;'; ?>">
                    <?php echo $total_net_movement >= 0 ? '+' : ''; ?><?php echo $total_net_movement; ?>
                </td>
                <td></td>
            </tr>
        </tfoot>
        <?php endif; ?>
    </table>
    <?php if (count($consumable_items) > 0): ?>
    <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
        <div style="background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; padding: 15px; border-radius: 8px; text-align: center;">
            <h3 style="margin: 0 0 5px 0; font-size: 1.1rem;">Total Added</h3>
            <p style="margin: 0; font-size: 1.8rem; font-weight: bold;">+<?php echo $total_added; ?></p>
        </div>
        <div style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; padding: 15px; border-radius: 8px; text-align: center;">
            <h3 style="margin: 0 0 5px 0; font-size: 1.1rem;">Total Released</h3>
            <p style="margin: 0; font-size: 1.8rem; font-weight: bold;">-<?php echo $total_released; ?></p>
        </div>
        <div style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 15px; border-radius: 8px; text-align: center;">
            <h3 style="margin: 0 0 5px 0; font-size: 1.1rem;">Net Movement</h3>
            <p style="margin: 0; font-size: 1.8rem; font-weight: bold;">
                <?php echo $total_net_movement >= 0 ? '+' : ''; ?><?php echo $total_net_movement; ?>
            </p>
        </div>
    </div>
    <?php endif;
    displayReportFooter($isDownload);
}
// NEW: Unit Tracking Report Function
function generateUnitTrackingReport($pdo, $filters, $isDownload = false) {
    $query = "SELECT u.*, i.item_name, i.classification, i.unit
              FROM inventory_units u
              JOIN inventory i ON u.inventory_id = i.id
              WHERE 1=1";
    $params = [];
    // Apply filters
    if (!empty($filters['location'])) {
        $query .= " AND i.location = ?";
        $params[] = $filters['location'];
    }
    if (!empty($filters['classification'])) {
        $query .= " AND i.classification = ?";
        $params[] = $filters['classification'];
    }
    $query .= " ORDER BY i.item_name, u.unit_property_number";
    $stmt = $pdo->prepare($query);
    $stmt->execute($params);
    $units = $stmt->fetchAll(PDO::FETCH_ASSOC);
    displayReportHeader("Unit Tracking Report", $filters['start_date'] ?? '', $filters['end_date'] ?? '', $filters['location'], $filters['classification'], $isDownload);
    ?>
    <table border="1" cellpadding="8" cellspacing="0" width="100%" style="border-collapse: collapse;">
        <thead>
            <tr style="background-color: #2c3e50; color: white;">
                <th>Property Number</th>
                <th>Item Name</th>
                <th>Classification</th>
                <th>Status</th>
                <th>Condition</th>
                <th>Current Location</th>
                <th>Date Added</th>
                <th>Notes</th>
            </tr>
        </thead>
        <tbody>
            <?php foreach ($units as $unit):
                $current_location = getUnitLocation($pdo, $unit['id']);
            ?>
            <tr>
                <td><strong><?php echo htmlspecialchars($unit['unit_property_number']); ?></strong></td>
                <td><?php echo htmlspecialchars($unit['item_name']); ?></td>
                <td><?php echo htmlspecialchars($unit['classification']); ?></td>
                <td align="center">
                    <span class="status-badge status-<?php echo strtolower(str_replace(' ', '-', $unit['unit_status'])); ?>">
                        <?php echo $unit['unit_status']; ?>
                    </span>
                </td>
                <td align="center">
                    <span class="condition-badge condition-<?php echo strtolower($unit['unit_condition']); ?>">
                        <?php echo $unit['unit_condition']; ?>
                    </span>
                </td>
                <td><?php echo $current_location; ?></td>
                <td><?php echo date('M j, Y', strtotime($unit['date_added'])); ?></td>
                <td><?php echo htmlspecialchars($unit['notes'] ?: 'N/A'); ?></td>
            </tr>
            <?php endforeach; ?>
        </tbody>
    </table>
    <?php
    displayReportFooter($isDownload);
}
// NEW: Functionality Check Report Function
function generateFunctionalityCheckReport($pdo, $filters, $isDownload = false) {
    $query = "SELECT fc.*, u.unit_property_number, i.item_name, i.classification
              FROM inventory_unit_functionality_checks fc
              JOIN inventory_units u ON fc.unit_id = u.id
              JOIN inventory i ON u.inventory_id = i.id
              WHERE fc.check_date BETWEEN ? AND ?";
    $params = [$filters['start_date'], $filters['end_date']];
    // Apply filters
    if (!empty($filters['location'])) {
        $query .= " AND i.location = ?";
        $params[] = $filters['location'];
    }
    if (!empty($filters['classification'])) {
        $query .= " AND i.classification = ?";
        $params[] = $filters['classification'];
    }
    $query .= " ORDER BY fc.check_date DESC";
    $stmt = $pdo->prepare($query);
    $stmt->execute($params);
    $functionality_checks = $stmt->fetchAll(PDO::FETCH_ASSOC);
    displayReportHeader("Functionality Check Report", $filters['start_date'], $filters['end_date'], $filters['location'], $filters['classification'], $isDownload);
    ?>
    <table border="1" cellpadding="8" cellspacing="0" width="100%" style="border-collapse: collapse;">
        <thead>
            <tr style="background-color: #16a085; color: white;">
                <th>Check Date</th>
                <th>Property Number</th>
                <th>Item Name</th>
                <th>Checked By</th>
                <th>Functionality Status</th>
                <th>Condition</th>
                <th>Maintenance Required</th>
                <th>Replacement Recommended</th>
                <th>Estimated Cost</th>
                <th>Next Check Date</th>
            </tr>
        </thead>
        <tbody>
            <?php foreach ($functionality_checks as $check): ?>
            <tr>
                <td><?php echo date('M j, Y', strtotime($check['check_date'])); ?></td>
                <td><strong><?php echo htmlspecialchars($check['unit_property_number']); ?></strong></td>
                <td><?php echo htmlspecialchars($check['item_name']); ?></td>
                <td><?php echo htmlspecialchars($check['checked_by']); ?></td>
                <td align="center">
                    <span class="functionality-badge functionality-<?php echo strtolower(str_replace(' ', '-', $check['functionality_status'])); ?>">
                        <?php echo $check['functionality_status']; ?>
                    </span>
                </td>
                <td align="center">
                    <span class="condition-badge condition-<?php echo strtolower($check['condition_status']); ?>">
                        <?php echo $check['condition_status']; ?>
                    </span>
                </td>
                <td><?php echo htmlspecialchars($check['maintenance_required'] ?: 'N/A'); ?></td>
                <td align="center"><?php echo $check['replacement_recommended'] ? 'Yes' : 'No'; ?></td>
                <td align="right">â‚±<?php echo number_format($check['estimated_maintenance_cost'], 2); ?></td>
                <td><?php echo $check['next_check_date'] ? date('M j, Y', strtotime($check['next_check_date'])) : 'Not Set'; ?></td>
            </tr>
            <?php endforeach; ?>
        </tbody>
    </table>
    <?php
    displayReportFooter($isDownload);
}
// Function to add common filters to report queries
function addReportFilters(&$query, &$params, $filters, $tableAlias = 'i') {
    if (!empty($filters['location'])) {
        $query .= " AND {$tableAlias}.location = ?";
        $params[] = $filters['location'];
    }
    if (!empty($filters['classification'])) {
        $query .= " AND {$tableAlias}.classification = ?";
        $params[] = $filters['classification'];
    }
    if (!empty($filters['item_type'])) {
        $query .= " AND {$tableAlias}.item_type = ?";
        $params[] = $filters['item_type'];
    }
    if (!empty($filters['floor_number'])) {
        $query .= " AND {$tableAlias}.floor_number = ?";
        $params[] = $filters['floor_number'];
    }
    if (!empty($filters['room_number'])) {
        $query .= " AND {$tableAlias}.room_number LIKE ?";
        $params[] = '%' . $filters['room_number'] . '%';
    }
}
// HTML Report Generation Functions (PRESERVED)
function generateInventorySummaryReport($pdo, $filters, $isDownload = false) {
    $query = "SELECT * FROM inventory i WHERE 1=1";
    $params = [];
    addReportFilters($query, $params, $filters);
    // Date filter specific to this report
    $query .= " AND i.date_added BETWEEN ? AND ?";
    $params[] = $filters['start_date'];
    $params[] = $filters['end_date'];
    $query .= " ORDER BY i.location, i.floor_number, i.room_number, i.classification";
    $stmt = $pdo->prepare($query);
    $stmt->execute($params);
    $items = $stmt->fetchAll(PDO::FETCH_ASSOC);
    displayReportHeader("Inventory Summary Report", $filters['start_date'], $filters['end_date'], $filters['location'], $filters['classification'], $isDownload);
    ?>
    <table border="1" cellpadding="8" cellspacing="0" width="100%" style="border-collapse: collapse;">
        <thead>
            <tr style="background-color: #4a6da7; color: white;">
                <th>Property No.</th>
                <th>Item Name</th>
                <th>Item Type</th>
                <th>Location</th>
                <th>Floor/Room</th>
                <th>Classification</th>
                <th>Quantity</th>
                <th>Unit</th>
                <th>Unit Price</th>
                <th>Total Value</th>
                <th>Status</th>
                <th>Date Added</th>
            </tr>
        </thead>
        <tbody>
            <?php
            $total_value = 0;
            foreach ($items as $item):
                $item_value = $item['quantity'] * $item['price'];
                $total_value += $item_value;
            ?>
            <tr>
                <td><?php echo htmlspecialchars($item['property_number'] ?: 'N/A'); ?></td>
                <td><?php echo htmlspecialchars($item['item_name']); ?></td>
                <td><?php echo htmlspecialchars($item['item_type']); ?></td>
                <td><?php echo htmlspecialchars($item['location'] ?: 'Not Issued'); ?></td>
                <td>
                    <?php if ($item['location'] === 'STII Main' && !empty($item['floor_number'])): ?>
                        Floor <?php echo htmlspecialchars($item['floor_number']); ?>
                        <?php if (!empty($item['room_number'])): ?>
                            , Room <?php echo htmlspecialchars($item['room_number']); ?>
                        <?php endif; ?>
                    <?php elseif (!empty($item['room_number'])): ?>
                        Room <?php echo htmlspecialchars($item['room_number']); ?>
                    <?php else: ?>
                        -
                    <?php endif; ?>
                </td>
                <td><?php echo htmlspecialchars($item['classification']); ?></td>
                <td align="center"><?php echo $item['quantity']; ?></td>
                <td align="center"><?php echo htmlspecialchars($item['unit']); ?></td>
                <td align="right">â‚±<?php echo number_format($item['price'], 2); ?></td>
                <td align="right">â‚±<?php echo number_format($item_value, 2); ?></td>
                <td align="center"><?php echo $item['status']; ?></td>
                <td><?php echo date('M j, Y', strtotime($item['date_added'])); ?></td>
            </tr>
            <?php endforeach; ?>
        </tbody>
        <tfoot>
            <tr style="background-color: #f0f0f0; font-weight: bold;">
                <td colspan="9" align="right">Total Inventory Value:</td>
                <td align="right">â‚±<?php echo number_format($total_value, 2); ?></td>
                <td colspan="2"></td>
            </tr>
        </tfoot>
    </table>
    <?php
    displayReportFooter($isDownload);
}
function generateBorrowingHistoryReport($pdo, $filters, $isDownload = false) {
    $query = "SELECT b.*, i.item_name, i.property_number, i.location, i.classification, i.unit
              FROM inventory_borrowing b
              JOIN inventory i ON b.inventory_id = i.id
              WHERE b.borrow_date BETWEEN ? AND ?";
    $params = [$filters['start_date'], $filters['end_date']];
    addReportFilters($query, $params, $filters);
    $query .= " ORDER BY b.borrow_date DESC";
    $stmt = $pdo->prepare($query);
    $stmt->execute($params);
    $borrowing_history = $stmt->fetchAll(PDO::FETCH_ASSOC);
    displayReportHeader("Borrowing History Report", $filters['start_date'], $filters['end_date'], $filters['location'], $filters['classification'], $isDownload);
    ?>
    <table border="1" cellpadding="8" cellspacing="0" width="100%" style="border-collapse: collapse;">
        <thead>
            <tr style="background-color: #9b59b6; color: white;">
                <th>Borrow Date</th>
                <th>Item Name</th>
                <th>Property No.</th>
                 <th>Location</th>
                <th>Borrower Name</th>
                <th>Department</th>
                <th>Quantity</th>
                <th>Unit</th>
                <th>Expected Return</th>
                <th>Actual Return</th>
                <th>Condition Before</th>
                <th>Condition After</th>
                <th>Status</th>
                <th>Notes</th>
            </tr>
        </thead>
        <tbody>
            <?php foreach ($borrowing_history as $borrow): ?>
            <tr>
                <td><?php echo date('M j, Y', strtotime($borrow['borrow_date'])); ?></td>
                <td><?php echo htmlspecialchars($borrow['item_name']); ?></td>
                <td><?php echo htmlspecialchars($borrow['property_number'] ?: 'N/A'); ?></td>
                 <td><?php echo formatLocation($borrow); ?></td>
                <td><?php echo htmlspecialchars($borrow['borrower_name']); ?></td>
                <td><?php echo htmlspecialchars($borrow['borrower_department']); ?></td>
                <td align="center"><?php echo $borrow['quantity_borrowed']; ?></td>
                <td align="center"><?php echo htmlspecialchars($borrow['unit']); ?></td>
                <td><?php echo date('M j, Y', strtotime($borrow['expected_return_date'])); ?></td>
                <td><?php echo $borrow['actual_return_date'] ? date('M j, Y', strtotime($borrow['actual_return_date'])) : 'Not Returned'; ?></td>
                <td align="center">
                    <span class="condition-badge condition-<?php echo strtolower($borrow['condition_before']); ?>">
                        <?php echo $borrow['condition_before']; ?>
                    </span>
                </td>
                <td align="center">
                    <?php if ($borrow['condition_after']): ?>
                    <span class="condition-badge condition-<?php echo strtolower($borrow['condition_after']); ?>">
                        <?php echo $borrow['condition_after']; ?>
                    </span>
                    <?php else: ?>
                    N/A
                    <?php endif; ?>
                </td>
                <td align="center">
                    <span class="status-badge status-<?php echo strtolower($borrow['status']); ?>">
                        <?php echo $borrow['status']; ?>
                    </span>
                </td>
                <td><?php echo htmlspecialchars($borrow['notes'] ?: 'N/A'); ?></td>
            </tr>
            <?php endforeach; ?>
        </tbody>
    </table>
    <?php
    displayReportFooter($isDownload);
}
function generateMovementHistoryReport($pdo, $filters, $isDownload = false) {
    // Get batch additions
    $batchQuery = "SELECT bh.*, i.item_name, i.property_number, i.location, i.classification, i.unit
                   FROM inventory_batch_history bh
                   JOIN inventory i ON bh.inventory_id = i.id
                   WHERE bh.batch_date BETWEEN ? AND ?";
    $paramsBatch = [$filters['start_date'], $filters['end_date']];
    addReportFilters($batchQuery, $paramsBatch, $filters);
    // Get releases
    $releaseQuery = "SELECT rh.*, i.item_name, i.property_number, i.location, i.classification, i.unit
                     FROM inventory_release_history rh
                     JOIN inventory i ON rh.inventory_id = i.id
                     WHERE rh.release_date BETWEEN ? AND ?";
    $paramsRelease = [$filters['start_date'], $filters['end_date']];
    addReportFilters($releaseQuery, $paramsRelease, $filters);
    $batchStmt = $pdo->prepare($batchQuery);
    $batchStmt->execute($paramsBatch);
    $batch_history = $batchStmt->fetchAll(PDO::FETCH_ASSOC);
    $releaseStmt = $pdo->prepare($releaseQuery);
    $releaseStmt->execute($paramsRelease);
    $release_history = $releaseStmt->fetchAll(PDO::FETCH_ASSOC);
    displayReportHeader("Movement History Report", $filters['start_date'], $filters['end_date'], $filters['location'], $filters['classification'], $isDownload);
    ?>
    <table border="1" cellpadding="8" cellspacing="0" width="100%" style="border-collapse: collapse;">
        <thead>
            <tr style="background-color: #3498db; color: white;">
                <th>Date</th>
                <th>Type</th>
                <th>Item Name</th>
                <th>Property No.</th>
                <th>Location</th>
                <th>Classification</th>
                <th>Quantity</th>
                <th>Unit</th>
                <th>Price</th>
                <th>Total Value</th>
                <th>Reference</th>
            </tr>
        </thead>
        <tbody>
            <?php
            $total_in_value = 0;
            $total_out_value = 0;
       
            // Batch movements (IN)
            foreach ($batch_history as $batch):
                $batch_value = $batch['batch_quantity'] * $batch['batch_price'];
                $total_in_value += $batch_value;
            ?>
            <tr style="background-color: #d4edda;">
                <td><?php echo date('M j, Y', strtotime($batch['batch_date'])); ?></td>
                <td><strong>STOCK IN</strong></td>
                <td><?php echo htmlspecialchars($batch['item_name']); ?></td>
                <td><?php echo htmlspecialchars($batch['property_number'] ?: 'N/A'); ?></td>
                <td><?php echo formatLocation($batch); ?></td>
                <td><?php echo htmlspecialchars($batch['classification']); ?></td>
                <td align="center">+<?php echo $batch['batch_quantity']; ?></td>
                <td align="center"><?php echo htmlspecialchars($batch['unit']); ?></td>
                <td align="right">â‚±<?php echo number_format($batch['batch_price'], 2); ?></td>
                <td align="right">â‚±<?php echo number_format($batch_value, 2); ?></td>
                <td><?php echo htmlspecialchars($batch['notes'] ?: 'N/A'); ?></td>
            </tr>
            <?php endforeach; ?>
       
            <?php foreach ($release_history as $release):
                // Get item price for value calculation
                $itemStmt = $pdo->prepare("SELECT price FROM inventory WHERE id = ?");
                $itemStmt->execute([$release['inventory_id']]);
                $item = $itemStmt->fetch(PDO::FETCH_ASSOC);
                $price = $item ? $item['price'] : 0;
                $release_value = $release['release_quantity'] * $price;
                $total_out_value += $release_value;
            ?>
            <tr style="background-color: #f8d7da;">
                <td><?php echo date('M j, Y', strtotime($release['release_date'])); ?></td>
                <td><strong>STOCK OUT</strong></td>
                <td><?php echo htmlspecialchars($release['item_name']); ?></td>
                <td><?php echo htmlspecialchars($release['property_number'] ?: 'N/A'); ?></td>
                <td><?php echo formatLocation($release); ?></td>
                <td><?php echo htmlspecialchars($release['classification']); ?></td>
                <td align="center" style="color: #e74c3c;">-<?php echo $release['release_quantity']; ?></td>
                <td align="center"><?php echo htmlspecialchars($release['unit']); ?></td>
                <td align="right">â‚±<?php echo number_format($price, 2); ?></td>
                <td align="right">â‚±<?php echo number_format($release_value, 2); ?></td>
                <td>Released to: <?php echo htmlspecialchars($release['released_to']); ?> - <?php echo htmlspecialchars($release['purpose'] ?: 'N/A'); ?></td>
            </tr>
            <?php endforeach; ?>
        </tbody>
        <tfoot>
            <tr style="background-color: #f0f0f0; font-weight: bold;">
                <td colspan="8" align="right">Total Stock In Value:</td>
                <td colspan="2" align="right">â‚±<?php echo number_format($total_in_value, 2); ?></td>
                <td></td>
            </tr>
            <tr style="background-color: #f0f0f0; font-weight: bold;">
                <td colspan="8" align="right">Total Stock Out Value:</td>
                <td colspan="2" align="right">â‚±<?php echo number_format($total_out_value, 2); ?></td>
                <td></td>
            </tr>
            <tr style="background-color: #e0e0e0; font-weight: bold;">
                <td colspan="8" align="right">Net Movement:</td>
                <td colspan="2" align="right">â‚±<?php echo number_format($total_in_value - $total_out_value, 2); ?></td>
                <td></td>
            </tr>
        </tfoot>
    </table>
    <?php
    displayReportFooter($isDownload);
}
function generateBatchHistoryReport($pdo, $filters, $isDownload = false) {
    $query = "SELECT bh.*, i.item_name, i.property_number, i.location, i.classification, i.unit
              FROM inventory_batch_history bh
              JOIN inventory i ON bh.inventory_id = i.id
              WHERE bh.batch_date BETWEEN ? AND ?";
    $params = [$filters['start_date'], $filters['end_date']];
    addReportFilters($query, $params, $filters);
    $query .= " ORDER BY bh.batch_date DESC";
    $stmt = $pdo->prepare($query);
    $stmt->execute($params);
    $batch_history = $stmt->fetchAll(PDO::FETCH_ASSOC);
    displayReportHeader("Batch Purchase History Report", $filters['start_date'], $filters['end_date'], $filters['location'], $filters['classification'], $isDownload);
    ?>
    <table border="1" cellpadding="8" cellspacing="0" width="100%" style="border-collapse: collapse;">
        <thead>
            <tr style="background-color: #f39c12; color: white;">
                <th>Batch Date</th>
                <th>Item Name</th>
                <th>Property No.</th>
                <th>Location</th>
                <th>Classification</th>
                <th>Quantity</th>
                <th>Unit</th>
                <th>Unit Price</th>
                <th>Total Value</th>
                <th>Notes</th>
                <th>Date Recorded</th>
            </tr>
        </thead>
        <tbody>
            <?php
            $total_value = 0;
            foreach ($batch_history as $batch):
                $batch_value = $batch['batch_quantity'] * $batch['batch_price'];
                $total_value += $batch_value;
            ?>
            <tr>
                <td><?php echo date('M j, Y', strtotime($batch['batch_date'])); ?></td>
                <td><?php echo htmlspecialchars($batch['item_name']); ?></td>
                <td><?php echo htmlspecialchars($batch['property_number'] ?: 'N/A'); ?></td>
                 <td><?php echo formatLocation($batch); ?></td>
                <td><?php echo htmlspecialchars($batch['classification']); ?></td>
                <td align="center"><?php echo $batch['batch_quantity']; ?></td>
                <td align="center"><?php echo htmlspecialchars($batch['unit']); ?></td>
                <td align="right">â‚±<?php echo number_format($batch['batch_price'], 2); ?></td>
                <td align="right">â‚±<?php echo number_format($batch_value, 2); ?></td>
                <td><?php echo htmlspecialchars($batch['notes'] ?: 'N/A'); ?></td>
                <td><?php echo date('M j, Y', strtotime($batch['date_recorded'])); ?></td>
            </tr>
            <?php endforeach; ?>
        </tbody>
        <tfoot>
            <tr style="background-color: #f0f0f0; font-weight: bold;">
                <td colspan="8" align="right">Total Batch Value:</td>
                <td align="right">â‚±<?php echo number_format($total_value, 2); ?></td>
                <td colspan="2"></td>
            </tr>
        </tfoot>
    </table>
    <?php
    displayReportFooter($isDownload);
}
function generateReleaseHistoryReport($pdo, $filters, $isDownload = false) {
    $query = "SELECT rh.*, i.item_name, i.property_number, i.location, i.classification, i.unit
              FROM inventory_release_history rh
              JOIN inventory i ON rh.inventory_id = i.id
              WHERE rh.release_date BETWEEN ? AND ?";
    $params = [$filters['start_date'], $filters['end_date']];
    addReportFilters($query, $params, $filters);
    $query .= " ORDER BY rh.release_date DESC";
    $stmt = $pdo->prepare($query);
    $stmt->execute($params);
    $release_history = $stmt->fetchAll(PDO::FETCH_ASSOC);
    displayReportHeader("Release History Report", $filters['start_date'], $filters['end_date'], $filters['location'], $filters['classification'], $isDownload);
    ?>
    <table border="1" cellpadding="8" cellspacing="0" width="100%" style="border-collapse: collapse;">
        <thead>
            <tr style="background-color: #e74c3c; color: white;">
                <th>Release Date</th>
                <th>Item Name</th>
                <th>Property No.</th>
                <th>Location</th>
                <th>Classification</th>
                <th>Quantity</th>
                <th>Unit</th>
                <th>Released To</th>
                <th>Purpose</th>
                <th>Date Recorded</th>
            </tr>
        </thead>
        <tbody>
            <?php foreach ($release_history as $release): ?>
            <tr>
                <td><?php echo date('M j, Y', strtotime($release['release_date'])); ?></td>
                <td><?php echo htmlspecialchars($release['item_name']); ?></td>
                <td><?php echo htmlspecialchars($release['property_number'] ?: 'N/A'); ?></td>
                <td><?php echo formatLocation($release); ?></td>
                <td><?php echo htmlspecialchars($release['classification']); ?></td>
                <td align="center"><?php echo $release['release_quantity']; ?></td>
                <td align="center"><?php echo htmlspecialchars($release['unit']); ?></td>
                <td><?php echo htmlspecialchars($release['released_to']); ?></td>
                <td><?php echo htmlspecialchars($release['purpose'] ?: 'N/A'); ?></td>
                <td><?php echo date('M j, Y', strtotime($release['date_recorded'])); ?></td>
            </tr>
            <?php endforeach; ?>
        </tbody>
    </table>
    <?php
    displayReportFooter($isDownload);
}
function generateLowStockReport($pdo, $filters, $isDownload = false) {
    $query = "SELECT * FROM inventory i WHERE quantity <= 5 AND status = 'Available'";
    $params = [];
    addReportFilters($query, $params, $filters);
    $query .= " ORDER BY quantity ASC";
    $stmt = $pdo->prepare($query);
    $stmt->execute($params);
    $low_stock_items = $stmt->fetchAll(PDO::FETCH_ASSOC);
    displayReportHeader("Low Stock Alert Report", '', '', $filters['location'], $filters['classification'], $isDownload);
    ?>
    <div style="margin-bottom: 20px; padding: 15px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px;">
        <h3 style="margin: 0; color: #856404;">âš ï¸ Low Stock Alert</h3>
        <p style="margin: 5px 0 0 0; color: #856404;">Items with 5 or less quantity remaining in stock.</p>
    </div>
    <table border="1" cellpadding="8" cellspacing="0" width="100%" style="border-collapse: collapse;">
        <thead>
            <tr style="background-color: #e74c3c; color: white;">
                <th>Property No.</th>
                <th>Item Name</th>
                <th>Location</th>
                <th>Classification</th>
                <th>Quantity</th>
                <th>Unit</th>
                <th>Alert Level</th>
                <th>Unit Price</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            <?php foreach ($low_stock_items as $item):
                $alert_level = '';
                $row_color = '';
                if ($item['quantity'] == 0) {
                    $alert_level = 'OUT OF STOCK';
                    $row_color = 'background-color: #f8d7da;';
                } elseif ($item['quantity'] <= 2) {
                    $alert_level = 'CRITICAL';
                    $row_color = 'background-color: #f8d7da;';
                } elseif ($item['quantity'] <= 5) {
                    $alert_level = 'LOW';
                    $row_color = 'background-color: #fff3cd;';
                }
            ?>
            <tr style="<?php echo $row_color; ?>">
                <td><?php echo htmlspecialchars($item['property_number'] ?: 'N/A'); ?></td>
                <td><?php echo htmlspecialchars($item['item_name']); ?></td>
                 <td><?php echo formatLocation($item); ?></td>
                <td><?php echo htmlspecialchars($item['classification']); ?></td>
                <td align="center"><strong><?php echo $item['quantity']; ?></strong></td>
                <td align="center"><?php echo htmlspecialchars($item['unit']); ?></td>
                <td align="center">
                    <span style="padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;
                        <?php
                        if ($alert_level == 'OUT OF STOCK') echo 'background-color: #dc3545; color: white;';
                        elseif ($alert_level == 'CRITICAL') echo 'background-color: #fd7e14; color: white;';
                        else echo 'background-color: #ffc107; color: black;';
                        ?>">
                        <?php echo $alert_level; ?>
                    </span>
                </td>
                <td align="right">â‚±<?php echo number_format($item['price'], 2); ?></td>
                <td align="center"><?php echo $item['status']; ?></td>
            </tr>
            <?php endforeach; ?>
        </tbody>
    </table>
    <?php if (count($low_stock_items) == 0): ?>
        <div style="text-align: center; padding: 40px; color: #28a745;">
            <h3>âœ… No Low Stock Items</h3>
            <p>All items have sufficient stock levels.</p>
        </div>
    <?php endif;
    displayReportFooter($isDownload);
}
// FIXED: School logo for PDF reports - using base64 encoded image
function getSchoolLogoBase64() {
    $logoPath = 'images/xyz.jpg';
    if (file_exists($logoPath)) {
        $logoData = file_get_contents($logoPath);
        $logoBase64 = base64_encode($logoData);
        return 'data:image/jpeg;base64,' . $logoBase64;
    }
    return 'images/xyz.jpg'; // Fallback to relative path if file doesn't exist
}
function displayReportHeader($title, $start_date, $end_date, $location, $classification, $isDownload = false) {
    $logo_src = getSchoolLogoBase64();
    if($isDownload) {
        // PDF styling for landscape orientation
        ?>
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title><?php echo $title; ?></title>
            <style>
                @page {
                    size: landscape;
                    margin: 20px;
                }
                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    margin: 0;
                    color: #333;
                    transform: scale(0.95);
                    transform-origin: top left;
                    width: 120%;
                }
                .header {
                    text-align: center;
                    margin-bottom: 20px;
                    border-bottom: 2px solid #4a6da7;
                    padding-bottom: 15px;
                    page-break-after: avoid;
                }
                .school-name {
                    font-size: 20px;
                    font-weight: bold;
                    color: #2c3e50;
                }
                .report-title {
                    font-size: 18px;
                    color: #4a6da7;
                    margin: 8px 0;
                }
                .report-info {
                    font-size: 12px;
                    color: #7f8c8d;
                    margin-bottom: 15px;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-bottom: 15px;
                    font-size: 10px;
                    page-break-inside: avoid;
                }
                th {
                    background-color: #4a6da7;
                    color: white;
                    padding: 8px;
                    text-align: left;
                    font-size: 9px;
                }
                td {
                    padding: 6px;
                    border: 1px solid #ddd;
                    font-size: 9px;
                }
                tfoot {
                    font-weight: bold;
                    background-color: #f8f9fa;
                }
                .footer {
                    margin-top: 20px;
                    text-align: center;
                    font-size: 10px;
                    color: #7f8c8d;
                    border-top: 1px solid #ddd;
                    padding-top: 8px;
                    page-break-before: avoid;
                }
                .condition-badge, .status-badge, .functionality-badge, .role-badge, .item-type-badge {
                    padding: 2px 6px;
                    border-radius: 8px;
                    font-size: 8px;
                    font-weight: bold;
                    color: white;
                }
                .condition-excellent { background-color: #27ae60; } .condition-good { background-color: #2ecc71; }
                .condition-fair { background-color: #f39c12; } .condition-poor { background-color: #e67e22; }
                .condition-defective { background-color: #e74c3c; } .status-borrowed { background-color: #3498db; }
                .status-returned { background-color: #27ae60; } .status-overdue { background-color: #e74c3c; }
                .status-damaged { background-color: #c0392b; } .status-issued { background-color: #e67e22; }
                .status-under-maintenance { background-color: #f39c12; } .status-for-replacement { background-color: #e74c3c; }
                .status-available { background-color: #27ae60; } .status-disposed { background-color: #7f8c8d; }
                .functionality-fully-functional { background-color: #27ae60; } .functionality-partially-functional { background-color: #f39c12; }
                .functionality-needs-maintenance { background-color: #e67e22; } .functionality-needs-replacement { background-color: #e74c3c; }
                .functionality-not-functional { background-color: #c0392b; }
                .no-print { display: none !important; }
            </style>
        </head>
        <body>
            <div class="header">
                <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 10px;">
                    <!-- CHANGED: Logo size for PDF reports to 1.6cm with 97% scale -->
                    <img src="<?php echo $logo_src; ?>" alt="School Logo" style="height: 45px; width: 45px; border-radius: 50%; object-fit: cover; border: 2px solid #4a6da7; margin-right: 15px; transform: scale(0.97);">
                    <div>
                        <div class="school-name">Sibugay Technical Institute Incorporated</div>
                        <div class="report-title"><?php echo $title; ?></div>
                    </div>
                </div>
                <div class="report-info">
                    <?php if ($start_date && $end_date): ?>
                        Period: <?php echo date('F j, Y', strtotime($start_date)); ?> to <?php echo date('F j, Y', strtotime($end_date)); ?>
                    <?php endif; ?>
                    <?php if ($location): ?> | Location: <?php echo $location; ?><?php endif; ?>
                    <?php if ($classification): ?> | Classification: <?php echo $classification; ?><?php endif; ?>
                    | Generated on: <?php echo date('F j, Y g:i A'); ?>
                </div>
            </div>
        <?php
        return;
    }
    ?>
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title><?php echo $title; ?></title>
        <style>
            body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; color: #333; }
            .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #4a6da7; padding-bottom: 20px; }
            .school-name { font-size: 24px; font-weight: bold; color: #2c3e50; }
            .report-title { font-size: 20px; color: #4a6da7; margin: 10px 0; }
            .report-info { font-size: 14px; color: #7f8c8d; margin-bottom: 20px; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 12px; }
            th { background-color: #4a6da7; color: white; padding: 12px; text-align: left; }
            td { padding: 10px; border: 1px solid #ddd; }
            tfoot { font-weight: bold; background-color: #f8f9fa; }
            .footer { margin-top: 30px; text-align: center; font-size: 12px; color: #7f8c8d; border-top: 1px solid #ddd; padding-top: 10px; }
            .condition-badge, .status-badge, .functionality-badge, .role-badge, .item-type-badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; color: white; }
            .condition-excellent, .condition-good { background-color: #27ae60; } .condition-good { background-color: #2ecc71; }
            .condition-fair { background-color: #f39c12; } .condition-poor { background-color: #e67e22; }
            .condition-defective { background-color: #e74c3c; } .status-borrowed { background-color: #3498db; }
            .status-returned { background-color: #27ae60; } .status-overdue { background-color: #e74c3c; }
            .status-damaged { background-color: #c0392b; } .status-issued { background-color: #e67e22; }
            .status-under-maintenance { background-color: #f39c12; } .status-for-replacement { background-color: #e74c3c; }
            .status-available { background-color: #27ae60; } .status-disposed { background-color: #7f8c8d; }
            .functionality-fully-functional { background-color: #27ae60; } .functionality-partially-functional { background-color: #f39c12; }
            .functionality-needs-maintenance { background-color: #e67e22; } .functionality-needs-replacement { background-color: #e74c3c; }
            .functionality-not-functional { background-color: #c0392b; }
            @media print { body { margin: 0; } .no-print { display: none; } }
        </style>
    </head>
    <body>
        <div class="header">
            <!-- ADDED: School Logo in Report Header -->
            <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                <img src="<?php echo $logo_src; ?>" alt="School Logo" style="height: 80px; width: 80px; border-radius: 50%; object-fit: cover; border: 2px solid #4a6da7; margin-right: 20px;">
                <div>
                    <div class="school-name">Sibugay Technical Institute Incorporated</div>
                    <div class="report-title"><?php echo $title; ?></div>
                </div>
            </div>
            <div class="report-info">
                <?php if ($start_date && $end_date): ?>
                    Period: <?php echo date('F j, Y', strtotime($start_date)); ?> to <?php echo date('F j, Y', strtotime($end_date)); ?>
                <?php endif; ?>
                <?php if ($location): ?> | Location: <?php echo $location; ?><?php endif; ?>
                <?php if ($classification): ?> | Classification: <?php echo $classification; ?><?php endif; ?>
                | Generated on: <?php echo date('F j, Y g:i A'); ?>
            </div>
        </div>
    <?php
}
function displayReportFooter($isDownload = false) {
?>
        <div class="footer">
            <p>Property Custodian Inventory System - STII Schools</p>
            <p>This is a computer-generated report. No signature is required.</p>
        </div>
    <?php if (!$isDownload): ?>
        <div class="no-print" style="margin-top: 20px; text-align: center;">
            <button onclick="window.print()" style="padding: 10px 20px; background-color: #4a6da7; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">Print Report</button>
            <button onclick="window.close()" style="padding: 10px 20px; background-color: #7f8c8d; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
        </div>
    </body>
    </html>
    <?php endif; ?>
<?php
}
// Handle form submissions
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // User Management Actions
    if (isset($_POST['add_user']) && isset($_SESSION['role']) && $_SESSION['role'] === 'admin') {
        $new_username = trim($_POST['new_username']);
        $new_password = $_POST['new_password'];
        $new_role = $_POST['new_role'];
        // Check if username already exists
        $checkStmt = $pdo->prepare("SELECT id FROM users WHERE username = ?");
        $checkStmt->execute([$new_username]);
        if ($checkStmt->fetch(PDO::FETCH_ASSOC)) {
            $error = "Username already exists.";
        } else {
            $hashedPassword = password_hash($new_password, PASSWORD_DEFAULT);
            $insertStmt = $pdo->prepare("INSERT INTO users (username, password, role) VALUES (?, ?, ?)");
            $insertStmt->execute([$new_username, $hashedPassword, $new_role]);
            $message = "User '$new_username' created successfully.";
        }
    }
    elseif (isset($_POST['delete_user']) && isset($_SESSION['role']) && $_SESSION['role'] === 'admin') {
        $user_id = intval($_POST['user_id']);
   
        // Prevent deleting own account
        if ($user_id == $_SESSION['user_id']) {
            $error = "You cannot delete your own account.";
        } else {
            $deleteStmt = $pdo->prepare("DELETE FROM users WHERE id = ?");
            $deleteStmt->execute([$user_id]);
            $message = "User deleted successfully.";
        }
    }
    elseif (isset($_POST['change_password'])) {
        $current_password = $_POST['current_password'];
        $new_password = $_POST['new_password'];
        $confirm_password = $_POST['confirm_password'];
        // Verify current password
        $userStmt = $pdo->prepare("SELECT password FROM users WHERE id = ?");
        $userStmt->execute([$_SESSION['user_id']]);
        $user = $userStmt->fetch(PDO::FETCH_ASSOC);
        if ($user && password_verify($current_password, $user['password'])) {
            if ($new_password === $confirm_password) {
                $hashedPassword = password_hash($new_password, PASSWORD_DEFAULT);
                $updateStmt = $pdo->prepare("UPDATE users SET password = ? WHERE id = ?");
                $updateStmt->execute([$hashedPassword, $_SESSION['user_id']]);
                $message = "Password changed successfully.";
            } else {
                $error = "New passwords do not match.";
            }
        } else {
            $error = "Current password is incorrect.";
        }
    }
    // Inventory Actions
    elseif (isset($_POST['add_item'])) {
        $property_number = trim($_POST['property_number']) ?: null;
        $item_name = trim($_POST['item_name']);
        $item_type = $_POST['item_type'];
        $unit = trim($_POST['unit']) ?: 'pcs';
   
        // CHANGED: Location logic - Non-consumable items start without location
        if ($item_type === 'Non-Consumable') {
            $location = NULL; // Non-consumable items start without a location
            $floor_number = NULL;
            $room_number = NULL;
        } else {
            $location = 'STII Main'; // Default location for consumable items
            $floor_number = NULL;
            $room_number = NULL;
        }
   
        $classification = $_POST['classification'];
        $quantity = intval($_POST['quantity']);
        $price = floatval($_POST['price']);
        $date_added = $_POST['date_added'];
        $is_borrowable = isset($_POST['is_borrowable']) ? 1 : 0;
   
        if ($item_type === 'Consumable') {
            $is_borrowable = 0;
        }
        // MODIFIED: Check if property number already exists
        if ($property_number) {
            $checkPropertyStmt = $pdo->prepare("SELECT id FROM inventory WHERE property_number = ?");
            $checkPropertyStmt->execute([$property_number]);
            if ($checkPropertyStmt->fetch(PDO::FETCH_ASSOC)) {
                $error = "Property number '$property_number' already exists.";
            }
        }
   
        if (!isset($error)) {
            // NEW: Use the getOrCreateInventoryGroup function to handle inventory grouping
            $inventory_id = getOrCreateInventoryGroup($pdo, $item_name, $item_type, $unit, $location, $floor_number, $room_number, $classification, $price, $date_added, $is_borrowable, $property_number);
       
            // Update the quantity for the inventory group
            $updateStmt = $pdo->prepare("UPDATE inventory SET quantity = quantity + ?, status = CASE WHEN (quantity + ?) <= 0 THEN 'Out of Stock' ELSE 'Available' END WHERE id = ?");
            $updateStmt->execute([$quantity, $quantity, $inventory_id]);
       
            // NEW: Create individual units for non-consumable items
            if ($item_type === 'Non-Consumable' && $quantity > 0) {
                $propertyNumbers = generatePropertyNumbers($property_number, $quantity, $pdo, $inventory_id);
                foreach ($propertyNumbers as $unitPropertyNumber) {
                    $unitStmt = $pdo->prepare("INSERT INTO inventory_units (inventory_id, unit_property_number, unit_status, unit_condition) VALUES (?, ?, 'Available', 'Good')");
                    $unitStmt->execute([$inventory_id, $unitPropertyNumber]);
                }
            }
       
            // Record batch history
            $batchStmt = $pdo->prepare("INSERT INTO inventory_batch_history (inventory_id, batch_quantity, batch_price, batch_date, notes, added_by) VALUES (?, ?, ?, ?, ?, ?)");
            $notes = $inventory_id ? "Added to existing inventory group." : "Initial inventory entry.";
            $batchStmt->execute([$inventory_id, $quantity, $price, $date_added, $notes, $_SESSION['username']]);
       
            $message = "Successfully added item '$item_name' to inventory.";
        }
    } elseif (isset($_POST['release_item'])) {
        $inventory_id = intval($_POST['inventory_id']);
        $release_quantity = intval($_POST['release_quantity']);
        $release_date = $_POST['release_date'];
        $released_to = trim($_POST['released_to']);
        $purpose = trim($_POST['purpose']);
        // Check if enough quantity is available and item is consumable
        $checkStmt = $pdo->prepare("SELECT quantity, item_name, unit, item_type FROM inventory WHERE id = ?");
        $checkStmt->execute([$inventory_id]);
        $item = $checkStmt->fetch(PDO::FETCH_ASSOC);
        // CHANGED: Only allow release of consumable items
        if ($item && $item['item_type'] === 'Consumable' && $item['quantity'] >= $release_quantity) {
            // Update inventory quantity
            $updateStmt = $pdo->prepare("UPDATE inventory SET quantity = quantity - ?, status = CASE WHEN (quantity - ?) <= 0 THEN 'Out of Stock' ELSE 'Available' END WHERE id = ?");
            $updateStmt->execute([$release_quantity, $release_quantity, $inventory_id]);
       
            // Record release history
            $releaseStmt = $pdo->prepare("INSERT INTO inventory_release_history (inventory_id, release_quantity, release_date, released_to, purpose) VALUES (?, ?, ?, ?, ?)");
            $releaseStmt->execute([$inventory_id, $release_quantity, $release_date, $released_to, $purpose]);
       
            $message = "Successfully released $release_quantity {$item['unit']} of '{$item['item_name']}' to $released_to.";
        } else {
            if ($item && $item['item_type'] !== 'Consumable') {
                $error = "Only consumable items can be released. Non-consumable items should be issued to departments instead.";
            } else {
                $error = "Insufficient quantity available for release.";
            }
        }
    } elseif (isset($_POST['restock_item'])) {
        $inventory_id = intval($_POST['restock_inventory_id']);
        $restock_quantity = intval($_POST['restock_quantity']);
        $restock_price = floatval($_POST['restock_price']);
        $restock_date = $_POST['restock_date'];
        // Get item details to check if it's non-consumable and has location
        $itemStmt = $pdo->prepare("SELECT item_type, property_number, location, item_name, classification, unit FROM inventory WHERE id = ?");
        $itemStmt->execute([$inventory_id]);
        $item = $itemStmt->fetch(PDO::FETCH_ASSOC);
        if ($item && $item['item_type'] === 'Non-Consumable' && !empty($item['location'])) {
            // This is an issued non-consumable item - transfer from main unissued pool
            $mainGroup = findMainUnissuedGroup($pdo, $item['item_name'], $item['classification'], $item['unit'], $item['item_type']);
       
            if (!$mainGroup) {
                $error = "Main inventory group for this item not found.";
            } else {
                // Get available units from the main group
                $unitsStmt = $pdo->prepare("
                    SELECT id, unit_property_number
                    FROM inventory_units
                    WHERE inventory_id = ? AND unit_status = 'Available'
                    LIMIT ?
                ");
                $unitsStmt->bindParam(1, $mainGroup['id'], PDO::PARAM_INT);
                $unitsStmt->bindParam(2, $restock_quantity, PDO::PARAM_INT);
                $unitsStmt->execute();
                $units = $unitsStmt->fetchAll(PDO::FETCH_ASSOC);
                if (count($units) < $restock_quantity) {
                    $error = "Insufficient available units in main inventory. Only " . count($units) . " available.";
                } else {
                    // Transfer units from main group to issued group
                    $transferred_units = [];
                    foreach ($units as $unit) {
                        // Update the unit to belong to the issued group
                        $updateUnitStmt = $pdo->prepare("UPDATE inventory_units SET inventory_id = ? WHERE id = ?");
                        $updateUnitStmt->execute([$inventory_id, $unit['id']]);
                        $transferred_units[] = $unit['unit_property_number'];
                    }
               
                    // Update inventory quantities
                    $updateMainStmt = $pdo->prepare("UPDATE inventory SET quantity = quantity - ? WHERE id = ?");
                    $updateMainStmt->execute([$restock_quantity, $mainGroup['id']]);
               
                    $updateIssuedStmt = $pdo->prepare("UPDATE inventory SET quantity = quantity + ?, price = ?, status = 'Available', last_updated = CURRENT_TIMESTAMP WHERE id = ?");
                    $updateIssuedStmt->execute([$restock_quantity, $restock_price, $inventory_id]);
               
                    $message = "Successfully transferred $restock_quantity units from main inventory to issued location. Property numbers: " . implode(', ', $transferred_units);
               
                    // Note: We do not record batch history for the issued group in this case
                }
            }
        } else {
            // Normal restock (for unissued non-consumable and consumable items)
       
            // Update inventory
            $updateStmt = $pdo->prepare("UPDATE inventory SET quantity = quantity + ?, price = ?, status = 'Available', last_updated = CURRENT_TIMESTAMP WHERE id = ?");
            $updateStmt->execute([$restock_quantity, $restock_price, $inventory_id]);
       
            // NEW: Create individual units for non-consumable items when restocking
            if ($item && $item['item_type'] === 'Non-Consumable' && $restock_quantity > 0) {
                $propertyNumbers = generatePropertyNumbers($item['property_number'], $restock_quantity, $pdo, $inventory_id);
                foreach ($propertyNumbers as $unitPropertyNumber) {
                    $unitStmt = $pdo->prepare("INSERT INTO inventory_units (inventory_id, unit_property_number, unit_status, unit_condition) VALUES (?, ?, 'Available', 'Good')");
                    $unitStmt->execute([$inventory_id, $unitPropertyNumber]);
                }
            }
       
            // Record batch history
            $batchStmt = $pdo->prepare("INSERT INTO inventory_batch_history (inventory_id, batch_quantity, batch_price, batch_date, notes, added_by) VALUES (?, ?, ?, ?, ?, ?)");
            $notes = "Restocked inventory.";
            $batchStmt->execute([$inventory_id, $restock_quantity, $restock_price, $restock_date, $notes, $_SESSION['username']]);
       
            $message = "Successfully restocked item." .
                       ($item && $item['item_type'] === 'Non-Consumable' ? " Generated $restock_quantity individual unit(s) with unique property numbers." : "");
        }
    } elseif (isset($_POST['borrow_item'])) {
        $inventory_id = intval($_POST['borrow_inventory_id']);
        $borrower_name = trim($_POST['borrower_name']);
        $borrower_department = trim($_POST['borrower_department']);
        $borrower_contact = trim($_POST['borrower_contact']);
        $borrow_quantity = intval($_POST['borrow_quantity']);
        $borrow_date = $_POST['borrow_date'];
        $expected_return_date = $_POST['expected_return_date'];
        $condition_before = $_POST['condition_before'];
        $borrow_notes = trim($_POST['borrow_notes']);
        // Check if item is borrowable and available
        $checkStmt = $pdo->prepare("SELECT quantity, item_name, unit, is_borrowable FROM inventory WHERE id = ?");
        $checkStmt->execute([$inventory_id]);
        $item = $checkStmt->fetch(PDO::FETCH_ASSOC);
        if ($item && $item['is_borrowable'] && $item['quantity'] >= $borrow_quantity) {
            // Update inventory quantity
            $updateStmt = $pdo->prepare("UPDATE inventory SET quantity = quantity - ?, status = CASE WHEN (quantity - ?) <= 0 THEN 'Out of Stock' ELSE 'Available' END WHERE id = ?");
            $updateStmt->execute([$borrow_quantity, $borrow_quantity, $inventory_id]);
       
            // Record borrowing
            $borrowStmt = $pdo->prepare("INSERT INTO inventory_borrowing (inventory_id, borrower_name, borrower_department, borrower_contact, quantity_borrowed, borrow_date, expected_return_date, condition_before, notes) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)");
            $borrowStmt->execute([$inventory_id, $borrower_name, $borrower_department, $borrower_contact, $borrow_quantity, $borrow_date, $expected_return_date, $condition_before, $borrow_notes]);
       
            $message = "Successfully borrowed $borrow_quantity {$item['unit']} of '{$item['item_name']}' to $borrower_name.";
        } else {
            $error = "Item is not available for borrowing or insufficient quantity.";
        }
    } elseif (isset($_POST['return_item'])) {
        $borrowing_id = intval($_POST['borrowing_id']);
        $actual_return_date = $_POST['actual_return_date'];
        $condition_after = $_POST['condition_after'];
        $return_status = $_POST['return_status'];
        $damage_notes = trim($_POST['damage_notes']);
        // Get borrowing details
        $borrowStmt = $pdo->prepare("SELECT inventory_id, quantity_borrowed FROM inventory_borrowing WHERE id = ?");
        $borrowStmt->execute([$borrowing_id]);
        $borrowing = $borrowStmt->fetch(PDO::FETCH_ASSOC);
        if ($borrowing) {
            // Update inventory quantity
            $updateStmt = $pdo->prepare("UPDATE inventory SET quantity = quantity + ?, status = 'Available' WHERE id = ?");
            $updateStmt->execute([$borrowing['quantity_borrowed'], $borrowing['inventory_id']]);
       
            // Update borrowing record
            $returnStmt = $pdo->prepare("UPDATE inventory_borrowing SET actual_return_date = ?, condition_after = ?, status = ?, damage_notes = ? WHERE id = ?");
            $returnStmt->execute([$actual_return_date, $condition_after, $return_status, $damage_notes, $borrowing_id]);
       
            $message = "Item returned successfully.";
        } else {
            $error = "Borrowing record not found.";
        }
    }
    // NEW: Handle functionality check for individual units
    elseif (isset($_POST['record_unit_functionality_check'])) {
        $unit_id = intval($_POST['unit_id']);
        $check_date = $_POST['check_date'];
        $checked_by = trim($_POST['checked_by']);
        $functionality_status = $_POST['functionality_status'];
        $condition_status = $_POST['condition_status'];
        $maintenance_required = trim($_POST['maintenance_required']);
        $replacement_recommended = isset($_POST['replacement_recommended']) ? 1 : 0;
        $estimated_maintenance_cost = floatval($_POST['estimated_maintenance_cost']);
        $next_check_date = $_POST['next_check_date'];
        $notes = trim($_POST['notes']);
        // Record functionality check
        $checkStmt = $pdo->prepare("INSERT INTO inventory_unit_functionality_checks (unit_id, check_date, checked_by, functionality_status, condition_status, maintenance_required, replacement_recommended, estimated_maintenance_cost, next_check_date, notes) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)");
        $checkStmt->execute([$unit_id, $check_date, $checked_by, $functionality_status, $condition_status, $maintenance_required, $replacement_recommended, $estimated_maintenance_cost, $next_check_date, $notes]);
   
        // Update unit condition
        $updateStmt = $pdo->prepare("UPDATE inventory_units SET unit_condition = ? WHERE id = ?");
        $updateStmt->execute([$condition_status, $unit_id]);
   
        $message = "Functionality check recorded successfully.";
    }
    // NEW: Handle department issue for non-consumable items with quantity
    // FIXED: Now copies the property number from the source item to the destination group
    elseif (isset($_POST['issue_to_department'])) {
        $inventory_id = intval($_POST['inventory_id']);
        $quantity = intval($_POST['quantity']);
        $department = trim($_POST['department']);
        $location = $_POST['location'];
        $floor_number = ($location === 'STII Main' && isset($_POST['floor_number']) && $_POST['floor_number'] !== '') ? intval($_POST['floor_number']) : null;
        $room_number = isset($_POST['room_number']) ? trim($_POST['room_number']) : null;
        $issued_to = trim($_POST['issued_to']);
        $issue_date = $_POST['issue_date'];
        $notes = trim($_POST['notes']);
        // Check if enough units are available
        $checkStmt = $pdo->prepare("
            SELECT COUNT(*) as available_count
            FROM inventory_units
            WHERE inventory_id = ? AND unit_status = 'Available'
        ");
        $checkStmt->execute([$inventory_id]);
        $available = $checkStmt->fetch(PDO::FETCH_ASSOC);
        if ($available && $available['available_count'] >= $quantity) {
            // Get source item details including property_number
            $sourceItemStmt = $pdo->prepare("SELECT item_name, item_type, unit, classification, price, property_number FROM inventory WHERE id = ?");
            $sourceItemStmt->execute([$inventory_id]);
            $sourceItem = $sourceItemStmt->fetch(PDO::FETCH_ASSOC);
            if ($sourceItem && $sourceItem['item_type'] === 'Non-Consumable') {
                // Get available units
                $unitsStmt = $pdo->prepare("
                    SELECT id, unit_property_number
                    FROM inventory_units
                    WHERE inventory_id = ? AND unit_status = 'Available'
                    LIMIT ?
                ");
                $unitsStmt->bindParam(1, $inventory_id, PDO::PARAM_INT);
                $unitsStmt->bindParam(2, $quantity, PDO::PARAM_INT);
                $unitsStmt->execute();
                $units = $unitsStmt->fetchAll(PDO::FETCH_ASSOC);
                // FIXED: Get or create inventory group for the destination location, passing the property_number
                $destination_inventory_id = getOrCreateInventoryGroup(
                    $pdo,
                    $sourceItem['item_name'],
                    $sourceItem['item_type'],
                    $sourceItem['unit'],
                    $location,
                    $floor_number,
                    $room_number,
                    $sourceItem['classification'],
                    $sourceItem['price'],
                    $issue_date,
                    0, // is_borrowable
                    $sourceItem['property_number'] // FIXED: Pass the property_number from source item
                );
                $issued_units = [];
                foreach ($units as $unit) {
                    // Update the unit to belong to the destination inventory group
                    $updateUnitStmt = $pdo->prepare("UPDATE inventory_units SET inventory_id = ? WHERE id = ?");
                    $updateUnitStmt->execute([$destination_inventory_id, $unit['id']]);
               
                    // Record department issue for each unit
                    $issueStmt = $pdo->prepare("INSERT INTO department_issue (unit_id, department, location, floor_number, room_number, issued_to, issue_date, issued_by, notes) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)");
                    $issueStmt->execute([$unit['id'], $department, $location, $floor_number, $room_number, $issued_to, $issue_date, $_SESSION['username'], $notes]);
               
                    // Update unit status to 'Issued'
                    $updateStmt = $pdo->prepare("UPDATE inventory_units SET unit_status = 'Issued' WHERE id = ?");
                    $updateStmt->execute([$unit['id']]);
               
                    $issued_units[] = $unit['unit_property_number'];
                }
           
                // Update source inventory quantity (decrease)
                $updateSourceStmt = $pdo->prepare("UPDATE inventory SET quantity = quantity - ? WHERE id = ?");
                $updateSourceStmt->execute([$quantity, $inventory_id]);
           
                // Update destination inventory quantity (increase)
                $updateDestStmt = $pdo->prepare("UPDATE inventory SET quantity = quantity + ? WHERE id = ?");
                $updateDestStmt->execute([$quantity, $destination_inventory_id]);
           
                $message = "Successfully issued $quantity item(s) to department. Property numbers: " . implode(', ', $issued_units);
            } else {
                $error = "Only non-consumable items can be issued to departments.";
            }
        } else {
            $error = "Insufficient available units. Only " . ($available['available_count'] ?? 0) . " units available.";
        }
    }
    // NEW: Handle return from department
    // FIXED: Now moves units back to main inventory group and preserves property number
    elseif (isset($_POST['return_from_department'])) {
        $issue_id = intval($_POST['issue_id']);
        // Get issue details and unit information
        $issueStmt = $pdo->prepare("
            SELECT di.*, u.id as unit_id, u.inventory_id as current_inventory_id, i.item_name, i.item_type, i.unit, i.classification, i.price, i.property_number
            FROM department_issue di
            JOIN inventory_units u ON di.unit_id = u.id
            JOIN inventory i ON u.inventory_id = i.id
            WHERE di.id = ?
        ");
        $issueStmt->execute([$issue_id]);
        $issue = $issueStmt->fetch(PDO::FETCH_ASSOC);
        if ($issue && $issue['item_type'] === 'Non-Consumable') {
            // Find or create the main inventory group (without specific location)
            $main_inventory_id = getOrCreateInventoryGroup(
                $pdo,
                $issue['item_name'],
                $issue['item_type'],
                $issue['unit'],
                null, // location
                null, // floor_number
                null, // room_number
                $issue['classification'],
                $issue['price'],
                date('Y-m-d'),
                0, // is_borrowable
                $issue['property_number'] // FIXED: Pass the property_number from the issued item
            );
            // Move unit back to main inventory group
            $updateUnitStmt = $pdo->prepare("UPDATE inventory_units SET inventory_id = ?, unit_status = 'Available' WHERE id = ?");
            $updateUnitStmt->execute([$main_inventory_id, $issue['unit_id']]);
       
            // Update inventory quantities
            $updateSourceStmt = $pdo->prepare("UPDATE inventory SET quantity = quantity - 1 WHERE id = ?");
            $updateSourceStmt->execute([$issue['current_inventory_id']]);
       
            $updateDestStmt = $pdo->prepare("UPDATE inventory SET quantity = quantity + 1 WHERE id = ?");
            $updateDestStmt->execute([$main_inventory_id]);
       
            // Delete the department issue record
            $deleteStmt = $pdo->prepare("DELETE FROM department_issue WHERE id = ?");
            $deleteStmt->execute([$issue_id]);
       
            $message = "Item successfully returned from department to main inventory.";
        } else {
            $error = "Department issue record not found or item is not non-consumable.";
        }
    }
}
// Get filter parameters for inventory page
$location_filter = isset($_GET['location']) ? $_GET['location'] : '';
$classification_filter = isset($_GET['classification']) ? $_GET['classification'] : '';
$status_filter = isset($_GET['status']) ? $_GET['status'] : '';
$search_filter = isset($_GET['search']) ? trim($_GET['search']) : '';
$item_type_filter = isset($_GET['item_type']) ? $_GET['item_type'] : '';
// NEW: Get floor and room number filters for inventory page
$floor_filter = isset($_GET['floor_number']) ? $_GET['floor_number'] : '';
$room_filter = isset($_GET['room_number']) ? trim($_GET['room_number']) : '';
// NEW: Check if viewing item details
$view_item_id = isset($_GET['view_item']) ? intval($_GET['view_item']) : 0;
if ($view_item_id > 0) {
    $item_details = getItemDetails($pdo, $view_item_id);
}
// NEW: Check if viewing functionality check details
$view_check_id = isset($_GET['view_check']) ? intval($_GET['view_check']) : 0;
if ($view_check_id > 0) {
    $check_details = getFunctionalityCheckDetails($pdo, $view_check_id);
}
// NEW: Check if viewing department issue details
$view_issue_id = isset($_GET['view_issue']) ? intval($_GET['view_issue']) : 0;
if ($view_issue_id > 0) {
    $issue_details = getDepartmentIssueDetails($pdo, $view_issue_id);
}
// Build the query with filters for inventory page
// REVISED: Query now includes floor_number and room_number in the main inventory table
$query = "SELECT i.*
          FROM inventory i
          WHERE 1=1";
$params = [];
if (!empty($location_filter)) {
    $query .= " AND i.location = ?";
    $params[] = $location_filter;
}
if (!empty($classification_filter)) {
    $query .= " AND i.classification = ?";
    $params[] = $classification_filter;
}
if (!empty($item_type_filter)) {
    $query .= " AND i.item_type = ?";
    $params[] = $item_type_filter;
}
if (!empty($status_filter)) {
    $query .= " AND i.status = ?";
    $params[] = $status_filter;
}
if (!empty($search_filter)) {
    $query .= " AND (i.item_name LIKE ? OR i.property_number LIKE ?)";
    $params[] = "%$search_filter%";
    $params[] = "%$search_filter%";
}
// NEW: Add floor and room number filtering
if (!empty($floor_filter)) {
    $query .= " AND i.floor_number = ?";
    $params[] = $floor_filter;
}
if (!empty($room_filter)) {
    $query .= " AND i.room_number LIKE ?";
    $params[] = "%$room_filter%";
}
$query .= " ORDER BY i.location, i.floor_number, i.room_number, i.item_name";
// Fetch data only if user is logged in
if (isset($_SESSION['user_id'])) {
    $stmt = $pdo->prepare($query);
    $stmt->execute($params);
    $items = $stmt->fetchAll(PDO::FETCH_ASSOC);
    // Fetch other data needed for dashboard etc.
    $borrowings_stmt = $pdo->prepare("SELECT b.*, i.item_name, i.property_number FROM inventory_borrowing b JOIN inventory i ON b.inventory_id = i.id WHERE b.status IN ('Borrowed', 'Overdue') ORDER BY b.expected_return_date ASC");
    $borrowings_stmt->execute();
    $active_borrowings = $borrowings_stmt->fetchAll(PDO::FETCH_ASSOC);
    // NEW: Fetch recent functionality checks for dashboard
    $functionality_checks_stmt = $pdo->prepare("
        SELECT fc.*, u.unit_property_number, i.item_name
        FROM inventory_unit_functionality_checks fc
        JOIN inventory_units u ON fc.unit_id = u.id
        JOIN inventory i ON u.inventory_id = i.id
        ORDER BY fc.check_date DESC LIMIT 10
    ");
    $functionality_checks_stmt->execute();
    $recent_functionality_checks = $functionality_checks_stmt->fetchAll(PDO::FETCH_ASSOC);
    // NEW: Fetch department issues for dashboard
    $department_issues_stmt = $pdo->prepare("
        SELECT di.*, u.unit_property_number, i.item_name
        FROM department_issue di
        JOIN inventory_units u ON di.unit_id = u.id
        JOIN inventory i ON u.inventory_id = i.id
        ORDER BY di.issue_date DESC LIMIT 10
    ");
    $department_issues_stmt->execute();
    $recent_department_issues = $department_issues_stmt->fetchAll(PDO::FETCH_ASSOC);
    $recent_releases_stmt = $pdo->prepare("SELECT rh.*, i.item_name, i.property_number FROM inventory_release_history rh JOIN inventory i ON rh.inventory_id = i.id ORDER BY rh.release_date DESC, rh.date_recorded DESC LIMIT 10");
    $recent_releases_stmt->execute();
    $recent_releases = $recent_releases_stmt->fetchAll(PDO::FETCH_ASSOC);
    // REVISED: Update summary by location to use the new inventory grouping
    $summary_by_location = [];
    $locations = ['STII Main', 'Sanito Campus', 'Eco-farm Campus'];
    foreach ($locations as $location) {
        $location_stmt = $pdo->prepare("SELECT COUNT(*) as count, SUM(quantity) as total_quantity FROM inventory WHERE location = ?");
        $location_stmt->execute([$location]);
        $summary = $location_stmt->fetch(PDO::FETCH_ASSOC);
        $summary_by_location[$location] = [
            'count' => $summary['count'] ?: 0,
            'total_quantity' => $summary['total_quantity'] ?: 0
        ];
    }
    // Get all inventory data for summary
    $all_items_stmt = $pdo->query("SELECT * FROM inventory");
    $all_items_data = $all_items_stmt->fetchAll(PDO::FETCH_ASSOC);
    $total_items_count = count($all_items_data);
    $total_quantity = 0; $total_value = 0;
    foreach ($all_items_data as $item) {
        $total_quantity += $item['quantity'];
        $total_value += $item['quantity'] * $item['price'];
    }
    $history_item = [];
    if (isset($_GET['view_history'])) {
        $history_id = intval($_GET['view_history']);
        $itemStmt = $pdo->prepare("SELECT item_name, property_number, unit, location FROM inventory WHERE id = ?");
        $itemStmt->execute([$history_id]);
        $history_item = $itemStmt->fetch(PDO::FETCH_ASSOC);
   
        if($history_item) {
            $historyStmt = $pdo->prepare("SELECT * FROM inventory_batch_history WHERE inventory_id = ? ORDER BY batch_date DESC, date_recorded DESC");
            $historyStmt->execute([$history_id]);
            $batch_history = $historyStmt->fetchAll(PDO::FETCH_ASSOC);
       
            $releaseStmt = $pdo->prepare("SELECT * FROM inventory_release_history WHERE inventory_id = ? ORDER BY release_date DESC, date_recorded DESC");
            $releaseStmt->execute([$history_id]);
            $release_history = $releaseStmt->fetchAll(PDO::FETCH_ASSOC);
       
            $borrowingStmt = $pdo->prepare("SELECT * FROM inventory_borrowing WHERE inventory_id = ? ORDER BY borrow_date DESC");
            $borrowingStmt->execute([$history_id]);
            $borrowing_history = $borrowingStmt->fetchAll(PDO::FETCH_ASSOC);
        }
    }
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Custodian Inventory System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for social media icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* UPDATED CSS FOR SOPHISTICATED AND PREMIUM LOOK */
        :root {
            --font-family: 'Poppins', sans-serif;
            --bg-color: #f8f9fd;
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-color: #1f2937;
            --text-color-light: #6b7280;
            --header-bg: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
            --border-color: rgba(0, 0, 0, 0.05);
            --shadow-color: rgba(79, 70, 229, 0.15);
            --backdrop-filter: blur(16px);
            --primary-color: #6366f1;
            --primary-color-dark: #4f46e5;
            --secondary-color: #9ca3af;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            --warning-color: #f59e0b;
            --borrow-color: #8b5cf6;
            --functionality-color: #06b6d4;
            --department-color: #ec4899;
            --accent-gold: #d4af37;
            --accent-silver: #c0c0c0;
        }
        .dark-mode {
            --bg-color: #111827;
            --card-bg: rgba(31, 41, 55, 0.85);
            --text-color: #f3f4f6;
            --text-color-light: #9ca3af;
            --header-bg: linear-gradient(135deg, #312e81 0%, #4338ca 100%);
            --border-color: rgba(255, 255, 255, 0.08);
            --shadow-color: rgba(0, 0, 0, 0.4);
            --accent-gold: #ffd700;
            --accent-silver: #a9a9a9;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
   
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
        }
   
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
   
        main {
            flex: 1;
        }
   
        .header-container {
            display: flex;
            align-items: center;
            background: var(--header-bg);
            color: white;
            padding: 25px 35px;
            margin-bottom: 35px;
            border-radius: 20px;
            box-shadow: 0 12px 35px var(--shadow-color);
            position: relative;
            overflow: hidden;
        }
        .header-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            transform: rotate(45deg);
        }
   
        .logo-container {
            flex-shrink: 0;
            margin-right: 30px;
            text-align: center;
        }
   
        .school-logo {
            height: 110px;
            width: 110px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid rgba(255,255,255,0.3);
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            background-color: #fff;
            transition: transform 0.3s ease;
            margin-left: 50px;
        }
        .school-logo:hover {
            transform: scale(1.05);
        }
   
        .header-text h1 { font-size: 2.4rem; margin-bottom: 5px; line-height: 1.2; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .header-text h2 { font-size: 1.3rem; margin-bottom: 8px; font-weight: 400; opacity: 0.95; }
        .header-text p { opacity: 0.85; font-weight: 300; font-size: 0.95rem; }
   
        /* NEW: Footer Styles (Enhanced) */
        .site-footer {
            background: linear-gradient(to top, var(--card-bg), transparent);
            border-top: 1px solid var(--border-color);
            padding: 40px 0 25px;
            margin-top: 50px;
            position: relative;
            overflow: hidden;
        }
        .site-footer::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(to right, transparent, var(--primary-color), transparent);
        }
        .footer-content {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 25px;
        }
        .footer-section {
            flex: 1;
            min-width: 300px;
            margin-bottom: 25px;
        }
        .footer-section h3 {
            color: var(--primary-color);
            margin-bottom: 25px;
            font-size: 1.3rem;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            display: inline-block;
            position: relative;
        }
        .footer-section h3::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(to right, var(--primary-color), transparent);
        }
        .developer-info {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .developer {
            background: linear-gradient(145deg, var(--bg-color), var(--card-bg));
            border-radius: 12px;
            padding: 20px;
            border-left: 5px solid var(--primary-color);
            box-shadow: 0 4px 15px var(--shadow-color);
            transition: transform 0.3s ease;
        }
        .developer:hover {
            transform: translateY(-5px);
        }
        .developer h4 {
            color: var(--text-color);
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        .developer p {
            margin: 6px 0;
            color: var(--text-color-light);
            font-size: 0.95rem;
        }
        .social-links {
            display: flex;
            gap: 18px;
            margin-top: 12px;
        }
        .social-link {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-color-dark));
            color: white;
            border-radius: 50%;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        .social-link:hover {
            background: linear-gradient(135deg, var(--primary-color-dark), var(--primary-color));
            transform: translateY(-3px) scale(1.1);
            box-shadow: 0 6px 12px var(--shadow-color);
        }
        .footer-bottom {
            text-align: center;
            margin-top: 35px;
            padding-top: 25px;
            border-top: 1px solid var(--border-color);
            color: var(--text-color-light);
            font-size: 0.95rem;
        }
        .contact-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .contact-item {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-color-light);
            transition: color 0.3s ease;
        }
        .contact-item:hover {
            color: var(--primary-color);
        }
        .contact-item i {
            color: var(--primary-color);
            width: 22px;
            font-size: 1.1rem;
        }
        /* Responsive footer */
        @media (max-width: 768px) {
            .footer-content {
                flex-direction: column;
            }
       
            .footer-section {
                min-width: 100%;
            }
        }
   
        /* Sidebar Navigation Styles (Enhanced) */
        .sidebar-toggle {
            position: absolute;
            top: 25px;
            left: 25px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 10px;
            width: 50px;
            height: 50px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding: 10px;
            transition: background 0.3s ease, transform 0.3s ease;
            z-index: 1002;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .sidebar-toggle:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.05); }
        .toggle-line {
            width: 28px;
            height: 3px;
            background: white;
            border-radius: 2px;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
   
        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 280px;
            height: 100vh;
            background: linear-gradient(to bottom, var(--card-bg), var(--bg-color));
            backdrop-filter: var(--backdrop-filter);
            -webkit-backdrop-filter: var(--backdrop-filter);
            border-right: 1px solid var(--border-color);
            box-shadow: 5px 0 25px var(--shadow-color);
            transition: left 0.3s ease-in-out;
            z-index: 1001;
            overflow-y: auto;
            padding: 25px 0;
        }
   
        .sidebar.active {
            left: 0;
        }
   
        .sidebar-header {
            padding: 25px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 25px;
        }
   
        .sidebar-logo {
            height: 90px;
            width: 90px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary-color);
            margin-bottom: 20px;
            box-shadow: 0 4px 12px var(--shadow-color);
            transition: transform 0.3s ease;
        }
        .sidebar-logo:hover {
            transform: rotate(360deg);
        }
   
        .sidebar-nav {
            list-style: none;
            padding: 0 20px;
        }
   
        .sidebar-nav-item {
            margin-bottom: 10px;
        }
   
        .sidebar-nav-link {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 14px 18px;
            color: var(--text-color);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-weight: 500;
            box-shadow: 0 1px 3px var(--shadow-color);
        }
   
        .sidebar-nav-link:hover {
            background-color: rgba(99, 102, 241, 0.15);
            color: var(--primary-color);
            transform: translateX(5px);
            box-shadow: 0 4px 12px var(--shadow-color);
        }
   
        .sidebar-nav-link.active {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-color-dark));
            color: white;
            box-shadow: 0 6px 20px var(--shadow-color);
        }
   
        .sidebar-nav-link .icon {
            width: 22px;
            height: 22px;
        }
   
        .sidebar-dark-mode {
            padding: 25px 20px;
            margin-top: 25px;
            border-top: 1px solid var(--border-color);
        }
   
        .dark-mode-toggle {
            background: rgba(156, 163, 175, 0.15);
            border: 1px solid var(--border-color);
            border-radius: 50px;
            width: 65px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 6px;
            transition: background 0.3s ease;
            margin-top: 12px;
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        .dark-mode-toggle:hover { background: rgba(156, 163, 175, 0.25); }
        .toggle-slider { width: 24px; height: 24px; background: linear-gradient(135deg, var(--primary-color), var(--primary-color-dark)); border-radius: 50%; transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94), background 0.3s; box-shadow: 0 2px 6px var(--shadow-color); }
        .dark-mode .toggle-slider { transform: translateX(30px); background: linear-gradient(135deg, #f3f4f6, #d1d5db); }
        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px var(--shadow-color);
            border: 1px solid var(--border-color);
            backdrop-filter: var(--backdrop-filter);
            -webkit-backdrop-filter: var(--backdrop-filter);
            animation: fadeInUp 0.6s ease-out forwards;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px var(--shadow-color);
        }
   
        .form-group { margin-bottom: 25px; }
        label { display: block; margin-bottom: 10px; font-weight: 500; font-size: 0.95rem; color: var(--text-color-light); }
   
        input[type="text"], input[type="password"], input[type="number"], input[type="date"], select, textarea {
            width: 100%;
            padding: 14px 18px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            font-size: 1rem;
            transition: border 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
            background: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-family);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
   
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
            background: white;
        }
        .dark-mode input:focus, .dark-mode select:focus, .dark-mode textarea:focus {
            background: #1f2937;
        }
        textarea { min-height: 120px; resize: vertical; }
        button, .btn {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-color-dark));
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        button:hover, .btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px var(--shadow-color); }
        button:active, .btn:active { transform: translateY(0); box-shadow: 0 2px 6px var(--shadow-color); }
        .btn-success { background: linear-gradient(135deg, var(--success-color), #059669); }
        .btn-success:hover { background: linear-gradient(135deg, #059669, var(--success-color)); }
        .btn-danger { background: linear-gradient(135deg, var(--danger-color), #dc2626); }
        .btn-danger:hover { background: linear-gradient(135deg, #dc2626, var(--danger-color)); }
        .btn-info { background: linear-gradient(135deg, var(--info-color), #2563eb); }
        .btn-info:hover { background: linear-gradient(135deg, #2563eb, var(--info-color)); }
        .btn-warning { background: linear-gradient(135deg, var(--warning-color), #d97706); }
        .btn-warning:hover { background: linear-gradient(135deg, #d97706, var(--warning-color)); }
        .btn-borrow { background: linear-gradient(135deg, var(--borrow-color), #7c3aed); }
        .btn-borrow:hover { background: linear-gradient(135deg, #7c3aed, var(--borrow-color)); }
        .btn-functionality { background: linear-gradient(135deg, var(--functionality-color), #0891b2); }
        .btn-functionality:hover { background: linear-gradient(135deg, #0891b2, var(--functionality-color)); }
        .btn-department { background: linear-gradient(135deg, var(--department-color), #db2777); }
        .btn-department:hover { background: linear-gradient(135deg, #db2777, var(--department-color)); }
        .btn-secondary { background: linear-gradient(135deg, var(--secondary-color), #6b7280); color: white; }
        .btn-secondary:hover { background: linear-gradient(135deg, #6b7280, var(--secondary-color)); }
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 25px; box-shadow: 0 4px 15px var(--shadow-color); border-radius: 12px; overflow: hidden; }
        thead { position: sticky; top: 0; background: linear-gradient(to bottom, var(--card-bg), var(--bg-color)); z-index: 1; box-shadow: 0 2px 5px var(--shadow-color); }
        th, td { padding: 18px; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        th { font-weight: 600; font-size: 0.85rem; text-transform: uppercase; color: var(--text-color-light); letter-spacing: 1px; background: var(--header-bg); color: white; }
        tbody tr { transition: background-color 0.3s ease, transform 0.3s ease; }
        tbody tr:hover { background-color: rgba(99, 102, 241, 0.08); transform: translateY(-2px); }
        .dark-mode tbody tr:hover { background-color: rgba(99, 102, 241, 0.12); }
        .actions { display: flex; gap: 12px; flex-wrap: wrap; }
        .actions button, .actions .btn { padding: 10px 18px; font-size: 0.9rem; }
        .flex-container { display: flex; gap: 30px; flex-wrap: wrap; }
        .flex-container > div { flex: 1; min-width: 300px; }
        @media (max-width: 992px) { .flex-container { flex-direction: column; } }
        /* Summary Cards on Dashboard (Premium Look) */
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 30px; margin-bottom: 35px; }
        .summary-card { padding: 30px; text-align: left; transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease; cursor: pointer; position: relative; overflow: hidden; border-radius: 20px; background: linear-gradient(145deg, var(--card-bg), var(--bg-color)); box-shadow: 0 10px 25px var(--shadow-color); }
        .summary-card:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 15px 40px var(--shadow-color); }
        .summary-card h3 { font-size: 1.1rem; margin-bottom: 12px; color: var(--text-color-light); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
        .summary-card .value { font-size: 2.5rem; font-weight: 700; color: var(--primary-color); line-height: 1.1; text-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .summary-card .icon { position: absolute; right: 25px; top: 50%; transform: translateY(-50%); font-size: 3.5rem; opacity: 0.08; color: var(--primary-color); transition: transform 0.3s ease, opacity 0.3s ease; }
        .summary-card:hover .icon { transform: translateY(-50%) scale(1.1); opacity: 0.15; }
        /* Modals (Premium) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.65); z-index: 1000; align-items: center; justify-content: center; animation: fadeIn 0.4s ease; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card-bg); border-radius: 24px; width: 90%; max-width: 850px; max-height: 88vh; display: flex; flex-direction: column; box-shadow: 0 15px 50px rgba(0,0,0,0.25); border: 1px solid var(--border-color); backdrop-filter: var(--backdrop-filter); -webkit-backdrop-filter: var(--backdrop-filter); animation: fadeInScale 0.5s ease-out; overflow: hidden; }
        .modal-header { padding: 25px 30px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; background: linear-gradient(to bottom, var(--card-bg), transparent); }
        .modal-header h2 { margin: 0; color: var(--primary-color); font-size: 1.5rem; font-weight: 600; }
        .close-modal { background: none; border: none; font-size: 32px; cursor: pointer; color: var(--text-color-light); transition: color 0.3s ease, transform 0.3s ease; }
        .close-modal:hover { color: var(--danger-color); transform: rotate(90deg) scale(1.1); }
        .modal-body { padding: 30px; overflow-y: auto; }
        /* Navigation */
        .nav-container { display: none; } /* Hide old navigation */
   
        .page-section { display: none; }
        .page-section.active { display: block; }
   
        .filters { display: flex; gap: 20px; margin-bottom: 25px; flex-wrap: wrap; align-items: flex-end; }
        .filters form { display: contents; }
        .filters .filter-group { flex: 1; min-width: 200px; }
   
        /* Badges & Indicators (Premium) */
        .status-badge, .condition-badge, .functionality-badge, .role-badge, .item-type-badge { padding: 6px 14px; border-radius: 24px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); transition: transform 0.3s ease; }
        .status-available, .status-returned, .condition-excellent, .condition-good, .functionality-fully-functional, .role-staff, .item-type-non-consumable { background-color: rgba(16, 185, 129, 0.15); color: #10b981; }
        .status-out-of-stock, .status-damaged, .condition-defective, .functionality-not-functional, .functionality-needs-replacement { background-color: rgba(239, 68, 68, 0.15); color: #ef4444; }
        .status-overdue, .status-under-maintenance, .condition-fair, .condition-poor, .functionality-partially-functional, .functionality-needs-maintenance, .item-type-consumable { background-color: rgba(245, 158, 11, 0.15); color: #f59e0b; }
        .status-borrowed, .role-admin { background-color: rgba(139, 92, 246, 0.15); color: #8b5cf6; }
        .status-issued, .status-disposed { background-color: rgba(156, 163, 175, 0.15); color: #9ca3af; }
        .property-number { font-family: 'Courier New', Courier, monospace; background-color: var(--border-color); padding: 4px 10px; border-radius: 8px; font-size: 0.85rem; display: inline-block; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
   
        .message, .error, .info-box { padding: 18px 25px; margin-bottom: 25px; border-radius: 16px; border-left: 6px solid; box-shadow: 0 4px 12px var(--shadow-color); transition: transform 0.3s ease; }
        .message { background-color: rgba(16, 185, 129, 0.1); border-color: var(--success-color); }
        .error { background-color: rgba(239, 68, 68, 0.1); border-color: var(--danger-color); }
        .info-box { background-color: rgba(59, 130, 246, 0.1); border-color: var(--info-color); }
        .tabs { display: flex; margin-bottom: 25px; border-bottom: 1px solid var(--border-color); overflow-x: auto; }
        .tab { padding: 12px 25px; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s ease; color: var(--text-color-light); font-weight: 500; white-space: nowrap; }
        .tab:hover { color: var(--primary-color); border-bottom-color: rgba(99, 102, 241, 0.3); }
        .tab.active { color: var(--primary-color); border-bottom-color: var(--primary-color); font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s ease; }
        /* Login Page styles (Premium) */
        .login-wrapper { display: flex; align-items: center; justify-content: center; min-height: 80vh; background: linear-gradient(to bottom right, var(--bg-color), var(--card-bg)); }
        .login-card { max-width: 480px; width: 100%; border-radius: 24px; box-shadow: 0 15px 40px var(--shadow-color); padding: 40px; }
        /* Conditional Sub-location fields */
        .sub-location-fields { display: none; }
   
        /* Animations */
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.92); } to { opacity: 1; transform: scale(1); } }
        /* NEW: Item Details Styles (Enhanced) */
        .item-details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        .item-details-header h2 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.8rem;
            font-weight: 600;
        }
        .back-button {
            background: linear-gradient(135deg, var(--secondary-color), #6b7280);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .back-button:hover {
            transform: translateX(-3px);
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        .units-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }
        .unit-card {
            background: linear-gradient(145deg, var(--card-bg), var(--bg-color));
            border-radius: 16px;
            padding: 25px;
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 15px var(--shadow-color);
        }
        .unit-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px var(--shadow-color);
        }
        .unit-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .unit-property-number {
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--primary-color);
        }
        .unit-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        .unit-actions button {
            padding: 8px 16px;
            font-size: 0.85rem;
        }
   
        /* NEW: Functionality Check History Styles (Enhanced) */
        .check-history {
            margin-top: 25px;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
        }
        .check-item {
            background: var(--bg-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid var(--functionality-color);
            box-shadow: 0 2px 8px var(--shadow-color);
            transition: transform 0.3s ease;
        }
        .check-item:hover {
            transform: translateX(5px);
        }
        .check-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .check-date {
            font-weight: bold;
            color: var(--text-color);
            font-size: 1.1rem;
        }
        .check-by {
            color: var(--text-color-light);
            font-size: 0.95rem;
        }
        /* NEW: Department Issue Styles (Enhanced) */
        .department-issue-card {
            background: linear-gradient(145deg, var(--card-bg), var(--bg-color));
            border-radius: 16px;
            padding: 25px;
            border: 1px solid var(--border-color);
            margin-bottom: 25px;
            box-shadow: 0 4px 15px var(--shadow-color);
        }
        .department-issue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .department-issue-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .info-item {
            display: flex;
            flex-direction: column;
            background: var(--bg-color);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        .info-label {
            font-size: 0.85rem;
            color: var(--text-color-light);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .info-value {
            font-weight: 500;
            font-size: 1.1rem;
        }
   
        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            .header-container {
                flex-direction: column;
                padding: 20px;
                text-align: center;
            }
            .logo-container {
                margin-right: 0;
                margin-bottom: 15px;
            }
            .school-logo {
                height: 90px;
                width: 90px;
                margin-left: 0;
            }
            .sidebar-toggle {
                top: 15px;
                left: 15px;
                width: 40px;
                height: 40px;
            }
            .toggle-line {
                width: 24px;
                height: 2px;
            }
            .sidebar {
                width: 250px;
            }
            .sidebar-header {
                padding: 20px;
            }
            .sidebar-logo {
                height: 70px;
                width: 70px;
            }
            .sidebar-nav-link {
                padding: 12px 15px;
                gap: 10px;
            }
            .flex-container {
                flex-direction: column;
                gap: 20px;
            }
            .summary-cards {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
            }
            .summary-card {
                padding: 20px;
            }
            .summary-card .value {
                font-size: 2rem;
            }
            .summary-card .icon {
                font-size: 3rem;
            }
            .card {
                padding: 20px;
            }
            th, td {
                padding: 12px;
            }
            .modal-content {
                width: 95%;
                max-height: 90vh;
            }
            .modal-body {
                padding: 20px;
            }
            .units-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 20px;
            }
            .unit-card {
                padding: 20px;
            }
            .unit-actions {
                flex-direction: column;
                gap: 10px;
            }
            .filters {
                flex-direction: column;
                gap: 15px;
            }
            .filter-group {
                min-width: 100%;
            }
            .tabs {
                flex-wrap: nowrap;
            }
            .tab {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            .login-card {
                padding: 30px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            .header-container {
                padding: 15px;
            }
            .school-logo {
                height: 70px;
                width: 70px;
            }
            .header-text h1 {
                font-size: 1.8rem;
            }
            .header-text h2 {
                font-size: 1.1rem;
            }
            .sidebar-toggle {
                top: 10px;
                left: 10px;
                width: 35px;
                height: 35px;
            }
            .toggle-line {
                width: 20px;
            }
            .sidebar {
                width: 100%;
                left: -100%;
            }
            .sidebar.active {
                left: 0;
            }
            .summary-cards {
                grid-template-columns: 1fr;
            }
            .card {
                padding: 15px;
            }
            th, td {
                padding: 10px;
                font-size: 0.9rem;
            }
            .actions {
                flex-direction: column;
                gap: 10px;
            }
            button, .btn {
                padding: 12px 20px;
                font-size: 0.9rem;
            }
            .modal-content {
                border-radius: 16px;
                padding: 15px;
            }
            .modal-header {
                padding: 20px 25px;
            }
            .modal-body {
                padding: 25px;
            }
            .form-group {
                margin-bottom: 20px;
            }
            input, select, textarea {
                padding: 12px 15px;
            }
        }
    </style>
</head>
<body>
    <?php if (isset($_SESSION['user_id'])): ?>
    <!-- NEW: Sidebar Navigation -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="images/xyz.jpg" alt="School Logo" class="sidebar-logo">
            <h3 style="color: var(--text-color); margin-bottom: 5px;">STII</h3>
            <p style="color: var(--text-color-light); font-size: 0.9rem;">Inventory System</p>
        </div>
   
        <ul class="sidebar-nav">
            <li class="sidebar-nav-item"><a href="?page=dashboard" class="sidebar-nav-link <?php echo $current_page == 'dashboard' ? 'active' : ''; ?>"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="9"></rect><rect x="14" y="3" width="7" height="5"></rect><rect x="14" y="12" width="7" height="9"></rect><rect x="3" y="16" width="7" height="5"></rect></svg>Dashboard</a></li>
            <li class="sidebar-nav-item"><a href="?page=inventory" class="sidebar-nav-link <?php echo $current_page == 'inventory' ? 'active' : ''; ?>"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>Inventory</a></li>
            <li class="sidebar-nav-item"><a href="?page=add_item" class="sidebar-nav-link <?php echo $current_page == 'add_item' ? 'active' : ''; ?>"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>Add Item</a></li>
            <li class="sidebar-nav-item"><a href="?page=department_issue" class="sidebar-nav-link <?php echo $current_page == 'department_issue' ? 'active' : ''; ?>"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>Department Issue</a></li>
            <li class="sidebar-nav-item"><a href="?page=release_item" class="sidebar-nav-link <?php echo $current_page == 'release_item' ? 'active' : ''; ?>"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>Release Item</a></li>
            <li class="sidebar-nav-item"><a href="?page=borrowing" class="sidebar-nav-link <?php echo $current_page == 'borrowing' ? 'active' : ''; ?>"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 3h5"></path><path d="M8 21H3v-5"></path><path d="M21 3l-7.53 7.53"></path><path d="M3 21l7.53-7.53"></path></svg>Borrowing</a></li>
            <li class="sidebar-nav-item"><a href="?page=functionality_checks" class="sidebar-nav-link <?php echo $current_page == 'functionality_checks' ? 'active' : ''; ?>"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>Checks</a></li>
            <li class="sidebar-nav-item"><a href="?page=room_checks" class="sidebar-nav-link <?php echo $current_page == 'room_checks' ? 'active' : ''; ?>"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"></polyline><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"></path></svg>Room Checks</a></li>
            <li class="sidebar-nav-item"><a href="?page=reports" class="sidebar-nav-link <?php echo $current_page == 'reports' ? 'active' : ''; ?>"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>Reports</a></li>
            <?php if (isset($_SESSION['role']) && $_SESSION['role'] === 'admin'): ?>
            <li class="sidebar-nav-item"><a href="?page=users" class="sidebar-nav-link <?php echo $current_page == 'users' ? 'active' : ''; ?>"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>Users</a></li>
            <?php endif; ?>
            <li class="sidebar-nav-item"><a href="?page=profile" class="sidebar-nav-link <?php echo $current_page == 'profile' ? 'active' : ''; ?>"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>Profile</a></li>
            <li class="sidebar-nav-item"><a href="?action=logout" class="sidebar-nav-link"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>Logout</a></li>
        </ul>
   
        <div class="sidebar-dark-mode">
            <p style="color: var(--text-color); margin-bottom: 10px; font-weight: 500;">Dark Mode</p>
            <div class="dark-mode-toggle" id="sidebarDarkModeToggle">
                <div class="toggle-slider"></div>
            </div>
        </div>
    </div>
    <div class="container">
        <header class="header-container">
            <!-- NEW: Sidebar Toggle Button -->
            <button class="sidebar-toggle" id="sidebarToggle">
                <div class="toggle-line"></div>
                <div class="toggle-line"></div>
                <div class="toggle-line"></div>
            </button>
       
            <div class="logo-container">
                <img src="images/xyz.jpg" alt="School Logo" class="school-logo">
            </div>
            <div class="header-text">
                <h1>Sibugay Technical Institute Inc.</h1>
                <h2>Property Custodian Inventory System</h2>
                <p>Welcome, <strong><?php echo htmlspecialchars($_SESSION['username'] ?? 'User'); ?></strong> (<?php echo htmlspecialchars($_SESSION['role'] ?? 'Role'); ?>)</p>
            </div>
        </header>
        <main>
            <?php if (isset($databaseCreated) && $databaseCreated): ?>
                <div class="message"><h3>ðŸŽ‰ System Setup Complete!</h3><p>The database and all necessary tables have been created successfully. You can now start using the inventory system.</p></div>
            <?php endif; ?>
            <?php if (isset($error)): ?>
                <div class="error"><?php echo $error; ?></div>
            <?php endif; ?>
            <?php if (isset($message)): ?>
                <div class="message"><?php echo $message; ?></div>
            <?php endif; ?>
            <!-- NEW: Item Details Page -->
            <?php if ($view_item_id > 0 && isset($item_details)): ?>
            <div id="item_details" class="page-section active">
                <div class="card">
                    <div class="item-details-header">
                        <div>
                            <h2>Item Details: <?php echo htmlspecialchars($item_details['item_name']); ?></h2>
                            <p style="color: var(--text-color-light); margin: 5px 0 0 0;">
                                <?php echo htmlspecialchars($item_details['classification']); ?> |
                                <?php echo formatLocation($item_details); ?> |
                                <span class="item-type-badge item-type-<?php echo strtolower($item_details['item_type']); ?>">
                                    <?php echo $item_details['item_type']; ?>
                                </span>
                            </p>
                        </div>
                        <a href="?page=inventory" class="back-button">â† Back to Inventory</a>
                    </div>
                    <div class="flex-container">
                        <div style="flex: 1;">
                            <h3>Item Information</h3>
                            <table>
                                <tr><td><strong>Property Number:</strong></td><td><?php echo htmlspecialchars($item_details['property_number'] ?: 'N/A'); ?></td></tr>
                                <tr><td><strong>Item Type:</strong></td><td><?php echo htmlspecialchars($item_details['item_type']); ?></td></tr>
                                <tr><td><strong>Unit:</strong></td><td><?php echo htmlspecialchars($item_details['unit']); ?></td></tr>
                                <tr><td><strong>Location:</strong></td><td><?php echo formatLocation($item_details); ?></td></tr>
                                <tr><td><strong>Classification:</strong></td><td><?php echo htmlspecialchars($item_details['classification']); ?></td></tr>
                                <tr><td><strong>Price:</strong></td><td>â‚±<?php echo number_format($item_details['price'], 2); ?></td></tr>
                                <tr><td><strong>Status:</strong></td><td><span class="status-badge status-<?php echo strtolower(str_replace(' ', '-', $item_details['status'])); ?>"><?php echo $item_details['status']; ?></span></td></tr>
                                <tr><td><strong>Borrowable:</strong></td><td><?php echo $item_details['is_borrowable'] ? 'Yes' : 'No'; ?></td></tr>
                                <tr><td><strong>Date Added:</strong></td><td><?php echo date('M j, Y', strtotime($item_details['date_added'])); ?></td></tr>
                            </table>
                        </div>
                        <div style="flex: 1;">
                            <h3>Unit Summary</h3>
                            <div class="summary-cards">
                                <div class="summary-card card">
                                    <h3>Total Units</h3>
                                    <p class="value"><?php echo $item_details['total_units']; ?></p>
                                </div>
                                <div class="summary-card card">
                                    <h3>Available Units</h3>
                                    <p class="value"><?php echo $item_details['available_units']; ?></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <h3 style="margin-top: 30px;">Individual Units</h3>
                    <?php if (!empty($item_details['units'])): ?>
                        <div class="units-grid">
                            <?php foreach ($item_details['units'] as $unit): ?>
                            <div class="unit-card">
                                <div class="unit-card-header">
                                    <span class="unit-property_number"><?php echo htmlspecialchars($unit['unit_property_number']); ?></span>
                                    <div>
                                        <span class="status-badge status-<?php echo strtolower(str_replace(' ', '-', $unit['unit_status'])); ?>">
                                            <?php echo $unit['unit_status']; ?>
                                        </span>
                                        <span class="condition-badge condition-<?php echo strtolower($unit['unit_condition']); ?>">
                                            <?php echo $unit['unit_condition']; ?>
                                        </span>
                                    </div>
                                </div>
                                <div style="font-size: 0.9rem; color: var(--text-color-light);">
                                    <div>Current Location: <?php echo $unit['current_location']; ?></div>
                                    <div>Added: <?php echo date('M j, Y', strtotime($unit['date_added'])); ?></div>
                                    <?php if (!empty($unit['notes'])): ?>
                                        <div style="margin-top: 8px;">Notes: <?php echo htmlspecialchars($unit['notes']); ?></div>
                                    <?php endif; ?>
                                    <?php if ($unit['check_count'] > 0): ?>
                                        <div style="margin-top: 8px; color: var(--functionality-color);">
                                            <strong><?php echo $unit['check_count']; ?> check(s)</strong> - Last: <?php echo date('M j, Y', strtotime($unit['last_check_date'])); ?>
                                        </div>
                                    <?php endif; ?>
                                </div>
                                <div class="unit-actions">
                                    <?php if ($unit['unit_status'] === 'Available'): ?>
                                        <button class="btn btn-department" onclick="openDepartmentIssueModal(<?php echo $unit['id']; ?>, '<?php echo htmlspecialchars(addslashes($unit['unit_property_number'])); ?>')">Issue to Department</button>
                                    <?php endif; ?>
                                    <button class="btn btn-functionality" onclick="openUnitFunctionalityCheckModal(<?php echo $unit['id']; ?>, '<?php echo htmlspecialchars(addslashes($unit['unit_property_number'])); ?>')">Record Check</button>
                                    <?php if (!empty($unit['functionality_checks'])): ?>
                                        <button class="btn btn-info" onclick="viewUnitCheckHistory(<?php echo $unit['id']; ?>)">View History</button>
                                    <?php endif; ?>
                                </div>
                                <!-- Functionality Check History for this unit -->
                                <?php if (!empty($unit['functionality_checks'])): ?>
                                <div class="check-history">
                                    <h4 style="margin-bottom: 10px;">Recent Checks</h4>
                                    <?php $recent_checks = array_slice($unit['functionality_checks'], 0, 3); ?>
                                    <?php foreach ($recent_checks as $check): ?>
                                    <div class="check-item">
                                        <div class="check-header">
                                            <span class="check-date"><?php echo date('M j, Y', strtotime($check['check_date'])); ?></span>
                                            <span class="functionality-badge functionality-<?php echo strtolower(str_replace(' ', '-', $check['functionality_status'])); ?>">
                                                <?php echo $check['functionality_status']; ?>
                                            </span>
                                        </div>
                                        <div class="check-by">By: <?php echo htmlspecialchars($check['checked_by']); ?></div>
                                        <?php if (!empty($check['maintenance_required'])): ?>
                                            <div style="margin-top: 5px; font-size: 0.85rem;">Maintenance: <?php echo htmlspecialchars($check['maintenance_required']); ?></div>
                                        <?php endif; ?>
                                    </div>
                                    <?php endforeach; ?>
                                </div>
                                <?php endif; ?>
                            </div>
                            <?php endforeach; ?>
                        </div>
                    <?php else: ?>
                        <p style="text-align: center; padding: 40px; color: var(--text-color-light);">No individual units tracked for this item.</p>
                    <?php endif; ?>
                </div>
            </div>
            <!-- NEW: Functionality Check Details Page -->
            <?php elseif ($view_check_id > 0 && isset($check_details)): ?>
            <div id="check_details" class="page-section active">
                <div class="card">
                    <div class="item-details-header">
                        <div>
                            <h2>Functionality Check Details</h2>
                            <p style="color: var(--text-color-light); margin: 5px 0 0 0;">
                                Property Number: <strong><?php echo htmlspecialchars($check_details['unit_property_number']); ?></strong> |
                                Item: <?php echo htmlspecialchars($check_details['item_name']); ?>
                            </p>
                        </div>
                        <a href="?page=functionality_checks" class="back-button">â† Back to Checks</a>
                    </div>
                    <div class="flex-container">
                        <div style="flex: 1;">
                            <h3>Check Information</h3>
                            <table>
                                <tr><td><strong>Property Number:</strong></td><td><?php echo htmlspecialchars($check_details['unit_property_number']); ?></td></tr>
                                <tr><td><strong>Item Name:</strong></td><td><?php echo htmlspecialchars($check_details['item_name']); ?></td></tr>
                                <tr><td><strong>Classification:</strong></td><td><?php echo htmlspecialchars($check_details['classification']); ?></td></tr>
                                <tr><td><strong>Check Date:</strong></td><td><?php echo date('M j, Y', strtotime($check_details['check_date'])); ?></td></tr>
                                <tr><td><strong>Checked By:</strong></td><td><?php echo htmlspecialchars($check_details['checked_by']); ?></td></tr>
                                <tr><td><strong>Functionality Status:</strong></td><td><span class="functionality-badge functionality-<?php echo strtolower(str_replace(' ', '-', $check_details['functionality_status'])); ?>"><?php echo $check_details['functionality_status']; ?></span></td></tr>
                                <tr><td><strong>Condition Status:</strong></td><td><span class="condition-badge condition-<?php echo strtolower($check_details['condition_status']); ?>"><?php echo $check_details['condition_status']; ?></span></td></tr>
                                <tr><td><strong>Replacement Recommended:</strong></td><td><?php echo $check_details['replacement_recommended'] ? 'Yes' : 'No'; ?></td></tr>
                                <?php if ($check_details['estimated_maintenance_cost'] > 0): ?>
                                <tr><td><strong>Estimated Maintenance Cost:</strong></td><td>â‚±<?php echo number_format($check_details['estimated_maintenance_cost'], 2); ?></td></tr>
                                <?php endif; ?>
                                <?php if ($check_details['next_check_date']): ?>
                                <tr><td><strong>Next Check Date:</strong></td><td><?php echo date('M j, Y', strtotime($check_details['next_check_date'])); ?></td></tr>
                                <?php endif; ?>
                            </table>
                        </div>
                    </div>
                    <?php if (!empty($check_details['maintenance_required'])): ?>
                    <div style="margin-top: 20px;">
                        <h3>Maintenance Required</h3>
                        <div style="background: var(--bg-color); padding: 15px; border-radius: 8px; border-left: 4px solid var(--warning-color);">
                            <?php echo nl2br(htmlspecialchars($check_details['maintenance_required'])); ?>
                        </div>
                    </div>
                    <?php endif; ?>
                    <?php if (!empty($check_details['notes'])): ?>
                    <div style="margin-top: 20px;">
                        <h3>Additional Notes</h3>
                        <div style="background: var(--bg-color); padding: 15px; border-radius: 8px; border-left: 4px solid var(--info-color);">
                            <?php echo nl2br(htmlspecialchars($check_details['notes'])); ?>
                        </div>
                    </div>
                    <?php endif; ?>
                </div>
            </div>
            <!-- NEW: Department Issue Details Page -->
            <?php elseif ($view_issue_id > 0 && isset($issue_details)): ?>
            <div id="issue_details" class="page-section active">
                <div class="card">
                    <div class="item-details-header">
                        <div>
                            <h2>Department Issue Details</h2>
                            <p style="color: var(--text-color-light); margin: 5px 0 0 0;">
                                Property Number: <strong><?php echo htmlspecialchars($issue_details['unit_property_number']); ?></strong> |
                                Item: <?php echo htmlspecialchars($issue_details['item_name']); ?>
                            </p>
                        </div>
                        <a href="?page=department_issue" class="back-button">â† Back to Department Issues</a>
                    </div>
                    <div class="department-issue-card">
                        <div class="department-issue-header">
                            <h3>Issue Information</h3>
                            <form method="POST" onsubmit="return confirm('Are you sure you want to return this item from the department?');">
                                <input type="hidden" name="issue_id" value="<?php echo $issue_details['id']; ?>">
                                <button type="submit" name="return_from_department" class="btn btn-success">Return from Department</button>
                            </form>
                        </div>
                   
                        <div class="department-issue-info">
                            <div class="info-item">
                                <span class="info-label">Property Number</span>
                                <span class="info-value"><?php echo htmlspecialchars($issue_details['unit_property_number']); ?></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Item Name</span>
                                <span class="info-value"><?php echo htmlspecialchars($issue_details['item_name']); ?></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Classification</span>
                                <span class="info-value"><?php echo htmlspecialchars($issue_details['classification']); ?></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Department</span>
                                <span class="info-value"><?php echo htmlspecialchars($issue_details['department']); ?></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Location</span>
                                <span class="info-value"><?php echo htmlspecialchars($issue_details['location']); ?></span>
                            </div>
                            <?php if ($issue_details['location'] === 'STII Main' && !empty($issue_details['floor_number'])): ?>
                            <div class="info-item">
                                <span class="info-label">Floor Number</span>
                                <span class="info-value"><?php echo htmlspecialchars($issue_details['floor_number']); ?></span>
                            </div>
                            <?php endif; ?>
                            <?php if (!empty($issue_details['room_number'])): ?>
                            <div class="info-item">
                                <span class="info-label">Room Number</span>
                                <span class="info-value"><?php echo htmlspecialchars($issue_details['room_number']); ?></span>
                            </div>
                            <?php endif; ?>
                            <div class="info-item">
                                <span class="info-label">Issued To</span>
                                <span class="info-value"><?php echo htmlspecialchars($issue_details['issued_to']); ?></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Issue Date</span>
                                <span class="info-value"><?php echo date('M j, Y', strtotime($issue_details['issue_date'])); ?></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Issued By</span>
                                <span class="info-value"><?php echo htmlspecialchars($issue_details['issued_by']); ?></span>
                            </div>
                        </div>
                   
                        <?php if (!empty($issue_details['notes'])): ?>
                        <div style="margin-top: 20px;">
                            <h4>Additional Notes</h4>
                            <div style="background: var(--bg-color); padding: 15px; border-radius: 8px; border-left: 4px solid var(--info-color);">
                                <?php echo nl2br(htmlspecialchars($issue_details['notes'])); ?>
                            </div>
                        </div>
                        <?php endif; ?>
                    </div>
                </div>
            </div>
            <?php else: ?>
            <!-- ALL ORIGINAL PAGES PRESERVED EXACTLY AS IN YOUR ORIGINAL CODE -->
            <div id="dashboard" class="page-section <?php echo $current_page == 'dashboard' && !$view_item_id && !$view_check_id && !$view_issue_id ? 'active' : ''; ?>">
                <div class="summary-cards">
                    <div class="summary-card card" onclick="window.location.href='?page=inventory'">
                        <h3>Total Items</h3>
                        <p class="value"><?php echo $total_items_count; ?></p>
                        <div class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path></svg></div>
                    </div>
                    <div class="summary-card card">
                        <h3>Total Quantity</h3>
                        <p class="value"><?php echo number_format($total_quantity); ?></p>
                         <div class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"></path></svg></div>
                    </div>
                    <div class="summary-card card">
                        <h3>Inventory Value</h3>
                        <p class="value">â‚±<?php echo number_format($total_value, 2); ?></p>
                         <div class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg></div>
                    </div>
                    <div class="summary-card card" onclick="window.location.href='?page=borrowing'">
                        <h3>Active Borrowings</h3>
                        <p class="value"><?php echo count($active_borrowings); ?></p>
                         <div class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 3h5"></path><path d="M8 21H3v-5"></path><path d="M21 3l-7.53 7.53"></path><path d="M3 21l7.53-7.53"></path></svg></div>
                    </div>
                </div>
                <div class="card">
                    <h2 style="margin-bottom: 20px;">Campus Overview</h2>
                    <div class="summary-cards">
                        <?php foreach ($locations as $location): ?>
                            <div class="location-card" style="padding: 20px; border-radius: 12px; background: var(--bg-color);">
                                <h3 style="color: var(--text-color); margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;"><?php echo $location; ?></h3>
                                <div style="display: flex; justify-content: space-around; text-align: center;">
                                    <div>
                                        <div style="font-size: 1.5rem; font-weight: 600;"><?php echo $summary_by_location[$location]['count'] ?: 0; ?></div>
                                        <div style="font-size: 0.8rem; color: var(--text-color-light);">Items</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 1.5rem; font-weight: 600;"><?php echo $summary_by_location[$location]['total_quantity'] ?: 0; ?></div>
                                        <div style="font-size: 0.8rem; color: var(--text-color-light);">Total Qty</div>
                                    </div>
                                </div>
                            </div>
                        <?php endforeach; ?>
                    </div>
                </div>
           
                <?php if (count($recent_department_issues) > 0): ?>
                <div class="card">
                    <h2 style="margin-bottom: 20px;">ðŸ¢ Recent Department Issues</h2>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th><th>Property No.</th><th>Item</th><th>Department</th><th>Location</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php $recent_issues = array_slice($recent_department_issues, 0, 5);
                                foreach ($recent_issues as $issue): ?>
                                <tr>
                                    <td><?php echo date('M j, Y', strtotime($issue['issue_date'])); ?></td>
                                    <td><strong><?php echo htmlspecialchars($issue['unit_property_number']); ?></strong></td>
                                    <td><?php echo htmlspecialchars($issue['item_name']); ?></td>
                                    <td><?php echo htmlspecialchars($issue['department']); ?></td>
                                    <td><?php echo htmlspecialchars($issue['location']); ?></td>
                                </tr>
                                <?php endforeach; ?>
                            </tbody>
                        </table>
                    </div>
                </div>
                <?php endif; ?>
           
                <?php if (count($recent_functionality_checks) > 0): ?>
                <div class="card">
                    <h2 style="margin-bottom: 20px;">ðŸ”§ Recent Functionality Checks</h2>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th><th>Property No.</th><th>Item Name</th><th>Checked By</th><th>Status</th><th>Condition</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php $recent_checks = array_slice($recent_functionality_checks, 0, 5);
                                foreach ($recent_checks as $check): ?>
                                <tr>
                                    <td><?php echo date('M j, Y', strtotime($check['check_date'])); ?></td>
                                    <td><strong><?php echo htmlspecialchars($check['unit_property_number']); ?></strong></td>
                                    <td><?php echo htmlspecialchars($check['item_name']); ?></td>
                                    <td><?php echo htmlspecialchars($check['checked_by']); ?></td>
                                    <td><span class="functionality-badge functionality-<?php echo strtolower(str_replace(' ', '-', $check['functionality_status'])); ?>"><?php echo $check['functionality_status']; ?></span></td>
                                    <td><span class="condition-badge condition-<?php echo strtolower($check['condition_status']); ?>"><?php echo $check['condition_status']; ?></span></td>
                                </tr>
                                <?php endforeach; ?>
                            </tbody>
                        </table>
                    </div>
                </div>
                <?php endif; ?>
            </div>
            <div id="inventory" class="page-section <?php echo $current_page == 'inventory' && !$view_item_id && !$view_check_id && !$view_issue_id ? 'active' : ''; ?>">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0;">Inventory Items</h2>
                        <a href="?page=add_item" class="btn btn-success">Add New Item</a>
                    </div>
                    <div class="filters">
                        <form method="GET" action="" id="inventoryFilterForm">
                            <input type="hidden" name="page" value="inventory">
                            <div class="filter-group">
                                <label for="search_filter">Search</label>
                                <input type="text" id="search_filter" name="search" placeholder="Item name or Property No." value="<?php echo htmlspecialchars($search_filter); ?>">
                            </div>
                            <div class="filter-group">
                                <label for="location_filter">Location</label>
                                <select id="location_filter" name="location">
                                    <option value="">All</option>
                                    <option value="STII Main" <?php echo $location_filter == 'STII Main' ? 'selected' : ''; ?>>STII Main</option>
                                    <option value="Sanito Campus" <?php echo $location_filter == 'Sanito Campus' ? 'selected' : ''; ?>>Sanito Campus</option>
                                    <option value="Eco-farm Campus" <?php echo $location_filter == 'Eco-farm Campus' ? 'selected' : ''; ?>>Eco-farm Campus</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="classification_filter">Classification</label>
                                <select id="classification_filter" name="classification">
                                    <option value="">All</option>
                                    <option value="Electronics and Equipments" <?php echo $classification_filter == 'Electronics and Equipments' ? 'selected' : ''; ?>>Electronics & Equipments</option>
                                    <option value="Office Supplies" <?php echo $classification_filter == 'Office Supplies' ? 'selected' : ''; ?>>Office Supplies</option>
                                    <option value="Sports" <?php echo $classification_filter == 'Sports' ? 'selected' : ''; ?>>Sports</option>
                                    <option value="Drums and Bugles" <?php echo $classification_filter == 'Drums and Bugles' ? 'selected' : ''; ?>>Drums and Bugles</option>
                                    <option value="Furniture" <?php echo $classification_filter == 'Furniture' ? 'selected' : ''; ?>>Furniture</option>
                                </select>
                            </div>
                             <div class="filter-group">
                                <label for="item_type_filter">Item Type</label>
                                <select id="item_type_filter" name="item_type">
                                    <option value="">All</option>
                                    <option value="Consumable" <?php echo $item_type_filter == 'Consumable' ? 'selected' : ''; ?>>Consumable</option>
                                    <option value="Non-Consumable" <?php echo $item_type_filter == 'Non-Consumable' ? 'selected' : ''; ?>>Non-Consumable</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="status_filter">Status</label>
                                <select id="status_filter" name="status">
                                    <option value="">All</option>
                                    <option value="Available" <?php echo $status_filter == 'Available' ? 'selected' : ''; ?>>Available</option>
                                    <option value="Out of Stock" <?php echo $status_filter == 'Out of Stock' ? 'selected' : ''; ?>>Out of Stock</option>
                                </select>
                            </div>
                       
                            <!-- NEW: Floor Number Filter -->
                            <div class="filter-group" id="floor-filter-group" style="display: <?php echo $location_filter == 'STII Main' ? 'block' : 'none'; ?>;">
                                <label for="floor_number">Floor Number</label>
                                <select id="floor_number" name="floor_number">
                                    <option value="">All</option>
                                    <?php for ($i = 1; $i <= 8; $i++): ?>
                                        <option value="<?php echo $i; ?>" <?php echo $floor_filter == $i ? 'selected' : ''; ?>>Floor <?php echo $i; ?></option>
                                    <?php endfor; ?>
                                </select>
                            </div>
                       
                            <!-- NEW: Room Number Filter -->
                            <div class="filter-group">
                                <label for="room_number">Room Number/Name</label>
                                <input type="text" id="room_number" name="room_number" placeholder="e.g., 101, Library" value="<?php echo htmlspecialchars($room_filter); ?>">
                            </div>
                       
                            <div class="filter-group">
                                <button type="submit" class="btn btn-info">Filter</button>
                                <a href="?page=inventory" class="btn btn-secondary">Clear</a>
                            </div>
                        </form>
                    </div>
               
                    <?php if (count($items) > 0): ?>
                        <div style="overflow-x: auto;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Item Name</th>
                                        <th>Property No.</th>
                                        <th>Location</th>
                                        <th>Floor/Room</th>
                                        <th>Quantity</th>
                                        <th>Price</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <?php foreach ($items as $item): ?>
                                    <tr>
                                        <td>
                                            <!-- NEW: Make item name clickable to view details -->
                                            <a href="?page=inventory&view_item=<?php echo $item['id']; ?>" style="color: var(--primary-color); text-decoration: none; font-weight: 500;">
                                                <?php echo htmlspecialchars($item['item_name']); ?>
                                            </a>
                                            <div style="font-size: 0.8rem; color: var(--text-color-light);"><?php echo htmlspecialchars($item['classification']); ?></div>
                                            <div><span class="item-type-badge item-type-<?php echo strtolower($item['item_type']); ?>"><?php echo $item['item_type']; ?></span></div>
                                        </td>
                                        <!-- FIXED: Property number now shows correctly for issued items -->
                                        <td><span class="property-number"><?php echo htmlspecialchars($item['property_number'] ?: 'N/A'); ?></span></td>
                                        <td><?php echo htmlspecialchars($item['location'] ?: 'Not Issued'); ?></td>
                                        <td>
                                            <?php if ($item['location'] === 'STII Main' && !empty($item['floor_number'])): ?>
                                                Floor <?php echo htmlspecialchars($item['floor_number']); ?>
                                                <?php if (!empty($item['room_number'])): ?>
                                                    , Room <?php echo htmlspecialchars($item['room_number']); ?>
                                                <?php endif; ?>
                                            <?php elseif (!empty($item['room_number'])): ?>
                                                Room <?php echo htmlspecialchars($item['room_number']); ?>
                                            <?php else: ?>
                                                -
                                            <?php endif; ?>
                                        </td>
                                        <td align="center"><?php echo $item['quantity']; ?> <?php echo htmlspecialchars($item['unit']); ?></td>
                                        <td align="right">â‚±<?php echo number_format($item['price'], 2); ?></td>
                                        <td><span class="status-badge status-<?php echo strtolower(str_replace(' ', '-', $item['status'])); ?>"><?php echo $item['status']; ?></span></td>
                                        <td class="actions">
                                            <button class="btn btn-info" onclick="window.location.href='?page=inventory&view_history=<?php echo $item['id']; ?>'">History</button>
                                            <button class="btn btn-success" onclick="openRestockModal(<?php echo $item['id']; ?>, '<?php echo htmlspecialchars(addslashes($item['item_name'])); ?>', <?php echo $item['price']; ?>, '<?php echo htmlspecialchars(addslashes($item['unit'])); ?>', '<?php echo $item['item_type']; ?>', '<?php echo $item['location'] ? 'true' : 'false'; ?>')">Restock</button>
                                            <!-- NEW: View Details button -->
                                            <a href="?page=inventory&view_item=<?php echo $item['id']; ?>" class="btn btn-info">View Details</a>
                                        </td>
                                    </tr>
                                    <?php endforeach; ?>
                                </tbody>
                            </table>
                        </div>
                    <?php else: ?>
                        <div style="text-align: center; padding: 40px;"><h3>No items found</h3><p>No inventory items match your criteria. Try adjusting filters or add a new item.</p></div>
                    <?php endif; ?>
                </div>
            </div>
            <!-- ALL OTHER ORIGINAL PAGES PRESERVED EXACTLY -->
            <div id="add_item" class="page-section <?php echo $current_page == 'add_item' ? 'active' : ''; ?>">
                <div class="card">
                    <h2>Add New Item/Batch</h2>
                    <form method="POST" id="addItemForm">
                        <div class="flex-container">
                            <div class="form-group" style="flex: 2;">
                                <label for="item_name">Item Name</label>
                                <input type="text" id="item_name" name="item_name" required>
                            </div>
                             <div class="form-group">
                                <label for="item_type">Item Type</label>
                                <select id="item_type" name="item_type" required>
                                    <option value="Non-Consumable">Non-Consumable</option>
                                    <option value="Consumable">Consumable</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="property_number">Property Number (Optional)</label>
                                <input type="text" id="property_number" name="property_number" placeholder="e.g., STII-COMP-001">
                                <small style="color: var(--text-color-light);">For Non-Consumable items with quantity > 1, unique numbers will be auto-generated</small>
                            </div>
                        </div>
                        <div class="flex-container">
                            <div class="form-group">
                                <label for="classification">Classification</label>
                                <select id="classification" name="classification" required>
                                    <option value="">Select Classification</option>
                                    <option value="Electronics and Equipments">Electronics & Equipments</option>
                                    <option value="Office Supplies">Office Supplies</option>
                                    <option value="Sports">Sports</option>
                                    <option value="Drums and Bugles">Drums and Bugles</option>
                                    <option value="Furniture">Furniture</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex-container">
                            <div class="form-group">
                                <label for="quantity">Quantity</label>
                                <input type="number" id="quantity" name="quantity" min="1" required value="1">
                            </div>
                            <div class="form-group">
                                <label for="unit">Unit</label>
                                <input type="text" id="unit" name="unit" required value="pcs" placeholder="e.g., pcs, box, ream, set">
                            </div>
                            <div class="form-group">
                                <label for="price">Price per Unit (â‚±)</label>
                                <input type="number" id="price" name="price" min="0" step="0.01" required value="0.00">
                            </div>
                             <div class="form-group">
                                <label for="date_added">Date of Entry</label>
                                <input type="date" id="date_added" name="date_added" required value="<?php echo date('Y-m-d'); ?>">
                            </div>
                        </div>
                        <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="is_borrowable" name="is_borrowable" value="1" style="width: auto; height: 18px;" checked>
                            <label for="is_borrowable" style="margin: 0;">This item can be borrowed</label>
                        </div>
                        <div class="form-group">
                            <button type="submit" name="add_item" class="btn-success">Add to Inventory</button>
                        </div>
                    </form>
                </div>
            </div>
            <!-- NEW: Department Issue Page (UPDATED WITH QUANTITY) -->
            <div id="department_issue" class="page-section <?php echo $current_page == 'department_issue' ? 'active' : ''; ?>">
                <div class="flex-container">
                    <div style="flex: 1.5;">
                        <div class="card">
                            <h2>Issue Item to Department</h2>
                            <form method="POST" id="departmentIssueForm">
                                <div class="form-group">
                                    <label for="inventory_id">Select Item (Non-Consumable with Available Units)</label>
                                    <select id="inventory_id" name="inventory_id" required>
                                        <option value="">Select Item to Issue</option>
                                        <?php
                                        // Get non-consumable items with available units
                                        $available_items_stmt = $pdo->prepare("
                                            SELECT i.id, i.item_name, i.property_number, i.location, i.classification,
                                                   COUNT(u.id) as available_units
                                            FROM inventory i
                                            LEFT JOIN inventory_units u ON i.id = u.inventory_id AND u.unit_status = 'Available'
                                            WHERE i.item_type = 'Non-Consumable'
                                            GROUP BY i.id
                                            HAVING available_units > 0
                                            ORDER BY i.item_name
                                        ");
                                        $available_items_stmt->execute();
                                        $available_items = $available_items_stmt->fetchAll(PDO::FETCH_ASSOC);
                                   
                                        foreach ($available_items as $item):
                                        ?>
                                            <option value="<?php echo $item['id']; ?>" data-available="<?php echo $item['available_units']; ?>">
                                                <?php echo htmlspecialchars($item['item_name']); ?> - Available: <?php echo $item['available_units']; ?> (<?php echo formatLocation($item); ?>)
                                            </option>
                                        <?php endforeach; ?>
                                    </select>
                                </div>
                                <div class="flex-container">
                                    <div class="form-group">
                                        <label for="quantity">Quantity to Issue</label>
                                        <input type="number" id="quantity" name="quantity" min="1" required value="1">
                                    </div>
                                    <div class="form-group">
                                        <small>Available: <span id="available_units">0</span> units</small>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="department">Department</label>
                                    <input type="text" id="department" name="department" required placeholder="e.g., IT Department, Accounting">
                                </div>
                                <div class="form-group">
                                    <label for="issued_to">Issued To (Person)</label>
                                    <input type="text" id="issued_to" name="issued_to" required placeholder="Name of person receiving the item">
                                </div>
                                <div class="form-group">
                                    <label for="location">Location</label>
                                    <select id="location" name="location" required>
                                        <option value="">Select Location</option>
                                        <option value="STII Main">STII Main</option>
                                        <option value="Sanito Campus">Sanito Campus</option>
                                        <option value="Eco-farm Campus">Eco-farm Campus</option>
                                    </select>
                                </div>
                           
                                <!-- Conditional fields for STII Main location -->
                                <div class="form-group sub-location-fields" id="floor-field-group" style="display: none;">
                                    <label for="floor_number">Floor Number</label>
                                    <select id="floor_number" name="floor_number">
                                        <option value="">Select Floor</option>
                                        <?php for ($i = 1; $i <= 8; $i++): ?>
                                            <option value="<?php echo $i; ?>">Floor <?php echo $i; ?></option>
                                        <?php endfor; ?>
                                    </select>
                                </div>
                           
                                <div class="form-group">
                                    <label for="room_number">Room Number/Name</label>
                                    <input type="text" id="room_number" name="room_number" placeholder="e.g., 101, Library">
                                </div>
                                <div class="form-group">
                                    <label for="issue_date">Issue Date</label>
                                    <input type="date" id="issue_date" name="issue_date" required value="<?php echo date('Y-m-d'); ?>">
                                </div>
                                <div class="form-group">
                                    <label for="notes">Notes</label>
                                    <textarea id="notes" name="notes" placeholder="Any additional information..."></textarea>
                                </div>
                                <div class="form-group">
                                    <button type="submit" name="issue_to_department" class="btn-department">Issue to Department</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div style="flex: 2;">
                        <div class="card">
                            <h2>Recent Department Issues</h2>
                            <?php if (count($recent_department_issues) > 0): ?>
                            <div style="overflow-x: auto;">
                                <table>
                                    <thead><tr><th>Date</th><th>Property No.</th><th>Item Name</th><th>Department</th><th>Location</th><th>Actions</th></tr></thead>
                                    <tbody>
                                        <?php foreach ($recent_department_issues as $issue): ?>
                                        <tr>
                                            <td><?php echo date('M j, Y', strtotime($issue['issue_date'])); ?></td>
                                            <td><strong><?php echo htmlspecialchars($issue['unit_property_number']); ?></strong></td>
                                            <td><?php echo htmlspecialchars($issue['item_name']); ?></td>
                                            <td><?php echo htmlspecialchars($issue['department']); ?></td>
                                            <td><?php echo htmlspecialchars($issue['location']); ?></td>
                                            <td class="actions">
                                                <a href="?page=department_issue&view_issue=<?php echo $issue['id']; ?>" class="btn btn-info">View Details</a>
                                            </td>
                                        </tr>
                                        <?php endforeach; ?>
                                    </tbody>
                                </table>
                            </div>
                            <?php else: ?>
                            <p style="text-align: center; padding: 20px;">No items have been issued to departments yet.</p>
                            <?php endif; ?>
                        </div>
                    </div>
                </div>
            </div>
            <div id="release_item" class="page-section <?php echo $current_page == 'release_item' ? 'active' : ''; ?>">
                <div class="flex-container">
                    <div style="flex: 1.5;">
                        <div class="card">
                            <h2>Release Item</h2>
                            <form method="POST">
                                <div class="form-group">
                                    <label for="inventory_id">Select Item (Only consumable items are shown)</label>
                                    <select id="inventory_id" name="inventory_id" required>
                                        <option value="">Select Item to Release</option>
                                        <?php foreach ($all_items_data as $item_opt): if ($item_opt['status'] === 'Available' && $item_opt['quantity'] > 0 && $item_opt['item_type'] === 'Consumable'): ?>
                                            <option value="<?php echo $item_opt['id']; ?>">
                                                <?php echo htmlspecialchars($item_opt['item_name']); ?> (<?php echo htmlspecialchars($item_opt['unit']); ?>) - <?php echo formatLocation($item_opt); ?> (Available: <?php echo $item_opt['quantity']; ?>)
                                            </option>
                                        <?php endif; endforeach; ?>
                                    </select>
                                </div>
                                <div class="flex-container">
                                    <div class="form-group">
                                        <label for="release_quantity">Quantity to Release</label>
                                        <input type="number" id="release_quantity" name="release_quantity" min="1" required value="1">
                                    </div>
                                    <div class="form-group">
                                        <label for="release_date">Date Released</label>
                                        <input type="date" id="release_date" name="release_date" required value="<?php echo date('Y-m-d'); ?>">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="released_to">Released To</label>
                                    <input type="text" id="released_to" name="released_to" required placeholder="Person or department">
                                </div>
                                <div class="form-group">
                                    <label for="purpose">Purpose</label>
                                    <textarea id="purpose" name="purpose" placeholder="e.g., Classroom use, event, etc."></textarea>
                                </div>
                                <div class="form-group">
                                    <button type="submit" name="release_item" class="btn-warning">Confirm Release</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div style="flex: 2;">
                        <div class="card">
                            <h2>Recent Releases</h2>
                            <?php if (count($recent_releases) > 0): ?>
                            <div style="overflow-x: auto;">
                                <table>
                                    <thead><tr><th>Item</th><th>Qty</th><th>Released To</th><th>Date</th></tr></thead>
                                    <tbody>
                                        <?php foreach ($recent_releases as $release): ?>
                                        <tr>
                                            <td><?php echo htmlspecialchars($release['item_name']); ?></td>
                                            <td><?php echo $release['release_quantity']; ?></td>
                                            <td><?php echo htmlspecialchars($release['released_to']); ?></td>
                                            <td><?php echo date('M j, Y', strtotime($release['release_date'])); ?></td>
                                        </tr>
                                        <?php endforeach; ?>
                                    </tbody>
                                </table>
                            </div>
                            <?php else: ?>
                            <p style="text-align: center; padding: 20px;">No items have been released yet.</p>
                            <?php endif; ?>
                        </div>
                    </div>
                </div>
            </div>
            <div id="borrowing" class="page-section <?php echo $current_page == 'borrowing' ? 'active' : ''; ?>">
                <div class="flex-container">
                    <div style="flex: 1.5;">
                        <div class="card">
                            <h2>Borrow Item</h2>
                            <form method="POST">
                                <div class="form-group">
                                    <label for="borrow_inventory_id">Select Item (Only borrowable items are shown)</label>
                                    <select id="borrow_inventory_id" name="borrow_inventory_id" required>
                                        <option value="">Select Item to Borrow</option>
                                        <?php foreach ($all_items_data as $item_opt): if ($item_opt['status'] === 'Available' && $item_opt['quantity'] > 0 && $item_opt['is_borrowable']): ?>
                                            <option value="<?php echo $item_opt['id']; ?>">
                                                 <?php echo htmlspecialchars($item_opt['item_name']); ?> (<?php echo htmlspecialchars($item_opt['unit']); ?>) - <?php echo formatLocation($item_opt); ?> (Available: <?php echo $item_opt['quantity']; ?>)
                                            </option>
                                        <?php endif; endforeach; ?>
                                    </select>
                                </div>
                                <div class="flex-container">
                                    <div class="form-group"><label for="borrower_name">Borrower Name</label><input type="text" id="borrower_name" name="borrower_name" required></div>
                                    <div class="form-group"><label for="borrower_department">Department</label><input type="text" id="borrower_department" name="borrower_department" required></div>
                                </div>
                                <div class="form-group"><label for="borrower_contact">Contact Info</label><input type="text" id="borrower_contact" name="borrower_contact" placeholder="Phone or email"></div>
                                <div class="flex-container">
                                    <div class="form-group"><label for="borrow_quantity">Quantity</label><input type="number" id="borrow_quantity" name="borrow_quantity" min="1" required value="1"></div>
                                    <div class="form-group"><label for="borrow_date">Borrow Date</label><input type="date" id="borrow_date" name="borrow_date" required value="<?php echo date('Y-m-d'); ?>"></div>
                                    <div class="form-group"><label for="expected_return_date">Expected Return</label><input type="date" id="expected_return_date" name="expected_return_date" required></div>
                                </div>
                                <div class="form-group"><label for="condition_before">Condition Before</label><select id="condition_before" name="condition_before" required><option value="Excellent">Excellent</option><option value="Good" selected>Good</option><option value="Fair">Fair</option><option value="Poor">Poor</option><option value="Defective">Defective</option></select></div>
                                <div class="form-group"><label for="borrow_notes">Notes</label><textarea id="borrow_notes" name="borrow_notes" placeholder="Purpose, special instructions..."></textarea></div>
                                <div class="form-group"><button type="submit" name="borrow_item" class="btn-borrow">Confirm Borrow</button></div>
                            </form>
                        </div>
                    </div>
                    <div style="flex: 2;">
                        <div class="card">
                            <h2>Active Borrowings</h2>
                            <?php if (count($active_borrowings) > 0): ?>
                            <div style="overflow-x: auto;">
                                <table>
                                    <thead><tr><th>Item</th><th>Borrower</th><th>Expected Return</th><th>Status</th><th>Actions</th></tr></thead>
                                    <tbody>
                                        <?php foreach ($active_borrowings as $borrow): $is_overdue = strtotime($borrow['expected_return_date']) < time() && $borrow['status'] == 'Borrowed'; ?>
                                        <tr>
                                            <td><?php echo htmlspecialchars($borrow['item_name']); ?></td>
                                            <td><?php echo htmlspecialchars($borrow['borrower_name']); ?></td>
                                            <td><?php echo date('M j, Y', strtotime($borrow['expected_return_date'])); ?></td>
                                            <td><span class="status-badge <?php echo $is_overdue ? 'status-overdue' : 'status-borrowed'; ?>"><?php echo $is_overdue ? 'Overdue' : $borrow['status']; ?></span></td>
                                            <td class="actions"><button class="btn btn-success" onclick="openReturnModal(<?php echo $borrow['id']; ?>, '<?php echo htmlspecialchars(addslashes($borrow['item_name'])); ?>', '<?php echo htmlspecialchars(addslashes($borrow['borrower_name'])); ?>')">Return</button></td>
                                        </tr>
                                        <?php endforeach; ?>
                                    </tbody>
                                </table>
                             <?php else: ?>
                            <p style="text-align: center; padding: 20px;">No items are currently borrowed.</p>
                            <?php endif; ?>
                        </div>
                    </div>
                </div>
            </div>
            <!-- NEW: Functionality Checks Page -->
            <div id="functionality_checks" class="page-section <?php echo $current_page == 'functionality_checks' ? 'active' : ''; ?>">
                <div class="card">
                    <h2>Recent Functionality Checks</h2>
                    <?php if (count($recent_functionality_checks) > 0): ?>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead><tr><th>Date</th><th>Property No.</th><th>Item Name</th><th>Checked By</th><th>Functionality</th><th>Condition</th><th>Actions</th></tr></thead>
                            <tbody>
                                <?php foreach ($recent_functionality_checks as $check): ?>
                                <tr>
                                    <td><?php echo date('M j, Y', strtotime($check['check_date'])); ?></td>
                                    <td><strong><?php echo htmlspecialchars($check['unit_property_number']); ?></strong></td>
                                    <td><?php echo htmlspecialchars($check['item_name']); ?></td>
                                    <td><?php echo htmlspecialchars($check['checked_by']); ?></td>
                                    <td><span class="functionality-badge functionality-<?php echo strtolower(str_replace(' ', '-', $check['functionality_status'])); ?>"><?php echo $check['functionality_status']; ?></span></td>
                                    <td><span class="condition-badge condition-<?php echo strtolower($check['condition_status']); ?>"><?php echo $check['condition_status']; ?></span></td>
                                    <td class="actions">
                                        <a href="?page=functionality_checks&view_check=<?php echo $check['id']; ?>" class="btn btn-info">View Details</a>
                                    </td>
                                </tr>
                                <?php endforeach; ?>
                            </tbody>
                        </table>
                    </div>
                     <?php else: ?>
                    <p style="text-align: center; padding: 20px;">No functionality checks have been recorded yet.</p>
                    <?php endif; ?>
                </div>
            </div>
            <!-- NEW: Room Functionality Checks Page -->
            <div id="room_checks" class="page-section <?php echo $current_page == 'room_checks' ? 'active' : ''; ?>">
                <div class="card">
                    <h2>Room Functionality Checks</h2>
                    <form method="GET" action="">
                        <input type="hidden" name="page" value="room_checks">
                        <div class="flex-container">
                            <div class="form-group">
                                <label for="check_location">Location</label>
                                <select id="check_location" name="check_location" onchange="this.form.submit()">
                                    <option value="">Select Location</option>
                                    <option value="STII Main" <?php echo isset($_GET['check_location']) && $_GET['check_location'] == 'STII Main' ? 'selected' : ''; ?>>STII Main</option>
                                    <option value="Sanito Campus" <?php echo isset($_GET['check_location']) && $_GET['check_location'] == 'Sanito Campus' ? 'selected' : ''; ?>>Sanito Campus</option>
                                    <option value="Eco-farm Campus" <?php echo isset($_GET['check_location']) && $_GET['check_location'] == 'Eco-farm Campus' ? 'selected' : ''; ?>>Eco-farm Campus</option>
                                </select>
                            </div>
                            <?php if (isset($_GET['check_location']) && $_GET['check_location'] == 'STII Main'): ?>
                            <div class="form-group">
                                <label for="check_floor">Floor</label>
                                <select id="check_floor" name="check_floor" onchange="this.form.submit()">
                                    <option value="">Select Floor</option>
                                    <?php for ($i = 1; $i <= 8; $i++): ?>
                                        <option value="<?php echo $i; ?>" <?php echo isset($_GET['check_floor']) && $_GET['check_floor'] == $i ? 'selected' : ''; ?>>Floor <?php echo $i; ?></option>
                                    <?php endfor; ?>
                                </select>
                            </div>
                            <?php endif; ?>
                            <div class="form-group">
                                <label for="check_room">Room Number/Name</label>
                                <input type="text" id="check_room" name="check_room" value="<?php echo isset($_GET['check_room']) ? htmlspecialchars($_GET['check_room']) : ''; ?>" placeholder="e.g., 101, Library">
                            </div>
                            <button type="submit" class="btn btn-info">View Room</button>
                        </div>
                    </form>
                    <?php
                    if (isset($_GET['check_location'])) {
                        $check_location = $_GET['check_location'];
                        $check_floor = isset($_GET['check_floor']) ? $_GET['check_floor'] : null;
                        $check_room = isset($_GET['check_room']) ? $_GET['check_room'] : '';
                        // Query for units in the selected room
                        $query = "SELECT di.unit_id, u.unit_property_number, u.unit_status, u.unit_condition, i.item_name, i.id as inventory_id
                                  FROM department_issue di
                                  JOIN inventory_units u ON di.unit_id = u.id
                                  JOIN inventory i ON u.inventory_id = i.id
                                  WHERE di.location = ?";
                        $params = [$check_location];
                        if ($check_location == 'STII Main' && $check_floor !== null) {
                            $query .= " AND di.floor_number = ?";
                            $params[] = $check_floor;
                        }
                        if (!empty($check_room)) {
                            $query .= " AND di.room_number LIKE ?";
                            $params[] = '%' . $check_room . '%';
                        }
                        $query .= " ORDER BY i.item_name, u.unit_property_number";
                        $stmt = $pdo->prepare($query);
                        $stmt->execute($params);
                        $room_units = $stmt->fetchAll(PDO::FETCH_ASSOC);
                        echo "<h3>Items in Selected Room</h3>";
                        if (count($room_units) > 0) {
                            echo "<div class='units-grid'>";
                            foreach ($room_units as $unit) {
                                echo "<div class='unit-card'>
                                        <div class='unit-card-header'>
                                            <span class='unit-property_number'>" . htmlspecialchars($unit['unit_property_number']) . "</span>
                                            <div>
                                                <span class='status-badge status-" . strtolower(str_replace(' ', '-', $unit['unit_status'])) . "'>" . $unit['unit_status'] . "</span>
                                                <span class='condition-badge condition-" . strtolower($unit['unit_condition']) . "'>" . $unit['unit_condition'] . "</span>
                                            </div>
                                        </div>
                                        <div style='font-size: 0.9rem; color: var(--text-color-light);'>
                                            <div>Item: " . htmlspecialchars($unit['item_name']) . "</div>
                                        </div>
                                        <div class='unit-actions'>
                                            <button class='btn btn-functionality' onclick='openUnitFunctionalityCheckModal(" . $unit['unit_id'] . ", \"" . htmlspecialchars(addslashes($unit['unit_property_number'])) . "\")'>Record Check</button>
                                        </div>
                                      </div>";
                            }
                            echo "</div>";
                        } else {
                            echo "<p>No items found in this room.</p>";
                        }
                    }
                    ?>
                </div>
            </div>
            <div id="reports" class="page-section <?php echo $current_page == 'reports' ? 'active' : ''; ?>">
                <div class="card">
                    <h2>Generate Reports</h2>
                    <form method="GET" action="" id="reportForm">
                        <input type="hidden" name="generate_report" value="1">
                        <div class="flex-container">
                            <div class="form-group" style="flex: 2;">
                                <label for="report_type">Report Type</label>
                                <select id="report_type" name="report_type" required>
                                    <option value="inventory_summary">Inventory Summary</option>
                                    <option value="movement_history">Movement History</option>
                                    <option value="batch_history">Batch Purchase History</option>
                                    <option value="release_history">Release History</option>
                                    <option value="borrowing_history">Borrowing History</option>
                                    <option value="functionality_check_report">Functionality Check Report</option>
                                    <option value="low_stock">Low Stock Alert</option>
                                    <option value="unit_tracking">Unit Tracking Report</option>
                                    <option value="consumable_stock_movement">Consumable Stock Movement</option>
                                    <option value="department_issue_report">Department Issue Report</option>
                                </select>
                            </div>
                             <div class="form-group"><label for="report_start_date">Start Date</label><input type="date" id="report_start_date" name="report_start_date"></div>
                             <div class="form-group"><label for="report_end_date">End Date</label><input type="date" id="report_end_date" name="report_end_date"></div>
                        </div>
                        <div class="flex-container">
                             <div class="form-group"><label for="report_location">Location Filter</label><select id="report_location" name="report_location"><option value="">All</option><option value="STII Main">STII Main</option><option value="Sanito Campus">Sanito Campus</option><option value="Eco-farm Campus">Eco-farm Campus</option></select></div>
                             <div class="form-group"><label for="report_classification">Classification Filter</label><select id="report_classification" name="report_classification"><option value="">All</option><option value="Electronics and Equipments">Electronics & Equipments</option><option value="Office Supplies">Office Supplies</option><option value="Sports">Sports</option><option value="Drums and Bugles">Drums & Bugles</option><option value="Furniture">Furniture</option></select></div>
                             <div class="form-group"><label for="report_item_type">Item Type Filter</label><select id="report_item_type" name="report_item_type"><option value="">All</option><option value="Consumable">Consumable</option><option value="Non-Consumable">Non-Consumable</option></select></div>
                        </div>
                        <!-- NEW: Floor and Room Number Filters -->
                        <div class="flex-container">
                            <div class="form-group" id="report-floor-field-group" style="display: <?php echo isset($_GET['report_location']) && $_GET['report_location'] == 'STII Main' ? 'block' : 'none'; ?>;">
                                <label for="report_floor_number">Floor Number</label>
                                <select id="report_floor_number" name="report_floor_number">
                                    <option value="">All</option>
                                    <?php for ($i = 1; $i <= 8; $i++): ?>
                                        <option value="<?php echo $i; ?>">Floor <?php echo $i; ?></option>
                                    <?php endfor; ?>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="report_room_number">Room Number/Name</label>
                                <input type="text" id="report_room_number" name="report_room_number" placeholder="e.g., 101, Library" value="<?php echo htmlspecialchars($_GET['report_room_number'] ?? ''); ?>">
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 15px; display: flex; gap: 10px;">
                            <button type="submit" class="btn btn-info" name="action" value="view">View Report</button>
                            <button type="submit" class="btn btn-success" name="action" value="download">Download (PDF)</button>
                        </div>
                    </form>
                </div>
            </div>
       
            <?php if (isset($_SESSION['role']) && $_SESSION['role'] === 'admin'): ?>
            <div id="users" class="page-section <?php echo $current_page == 'users' ? 'active' : ''; ?>">
                <div class="flex-container">
                    <div style="flex: 1;">
                        <div class="card">
                            <h2>Add New User</h2>
                            <form method="POST">
                                <div class="form-group">
                                    <label for="new_username">Username</label>
                                    <input type="text" id="new_username" name="new_username" required>
                                </div>
                                <div class="form-group">
                                    <label for="new_password">Password</label>
                                    <input type="password" id="new_password" name="new_password" required>
                                </div>
                                <div class="form-group">
                                    <label for="new_role">Role</label>
                                    <select id="new_role" name="new_role" required>
                                        <option value="staff">Staff</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                </div>
                                <button type="submit" name="add_user" class="btn-success">Create User</button>
                            </form>
                        </div>
                    </div>
                    <div style="flex: 2;">
                        <div class="card">
                            <h2>Manage Users</h2>
                            <?php
                            $users_stmt = $pdo->query("SELECT id, username, role, date_created FROM users ORDER BY username");
                            $users = $users_stmt->fetchAll(PDO::FETCH_ASSOC);
                            ?>
                            <div style="overflow-x: auto;">
                                <table>
                                    <thead><tr><th>Username</th><th>Role</th><th>Date Created</th><th>Actions</th></tr></thead>
                                    <tbody>
                                        <?php foreach ($users as $user): ?>
                                        <tr>
                                            <td><?php echo htmlspecialchars($user['username']); ?></td>
                                            <td><span class="role-badge role-<?php echo $user['role']; ?>"><?php echo htmlspecialchars($user['role']); ?></span></td>
                                            <td><?php echo date('M j, Y', strtotime($user['date_created'])); ?></td>
                                            <td class="actions">
                                                <form method="POST" onsubmit="return confirm('Are you sure you want to delete this user?');">
                                                    <input type="hidden" name="user_id" value="<?php echo $user['id']; ?>">
                                                    <button type="submit" name="delete_user" class="btn btn-danger">Delete</button>
                                                </form>
                                            </td>
                                        </tr>
                                        <?php endforeach; ?>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <?php endif; ?>
            <div id="profile" class="page-section <?php echo $current_page == 'profile' ? 'active' : ''; ?>">
                <div class="card" style="max-width: 600px; margin: auto;">
                    <h2>Change Password</h2>
                    <form method="POST">
                        <div class="form-group">
                            <label for="current_password">Current Password</label>
                            <input type="password" id="current_password" name="current_password" required>
                        </div>
                        <div class="form-group">
                            <label for="new_password">New Password</label>
                            <input type="password" id="new_password" name="new_password" required>
                        </div>
                        <div class="form-group">
                            <label for="confirm_password">Confirm New Password</label>
                            <input type="password" id="confirm_password" name="confirm_password" required>
                        </div>
                        <button type="submit" name="change_password" class="btn-primary">Update Password</button>
                    </form>
                </div>
            </div>
            <?php endif; // End of view_item_id, view_check_id and view_issue_id check ?>
        </main>
        <!-- NEW: Footer Section -->
        <footer class="site-footer">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Developer</h3>
                    <div class="developer-info">
                        <div class="developer">
                            <h4>Jagdish Love L. Berondo</h4>
                            <div class="social-links">
                                <a href="https://www.facebook.com/share/1GBkQWxisy/" class="social-link" target="_blank" title="Facebook">
                                    <i class="fab fa-facebook-f" ></i>
                                </a>
                                <a href="mailto:jagdishberondo@gmail.com" class="social-link" title="Email">
                                    <i class="fas fa-envelope"></i>
                                </a>
                            </div>
                            <p><i class="fas fa-phone"></i> +63 906 120 6043</p>
                        </div>
                   
                </div>
           
           
                </div>
           
           
            </div>
       
            <div class="footer-bottom">
                <p>&copy; <?php echo date('Y'); ?> Sibugay Technical Institute Inc. Inventory System. All rights reserved.</p>
                <p>Developed with â¤ï¸ for Sibugay Technical Institute Inc.</p>
            </div>
        </footer>
    </div>
    <?php else: // Show Login Page ?>
    <div class="login-wrapper">
        <div class="card login-card">
            <div style="text-align: center; margin-bottom: 20px;">
                <img src="images/xyz.jpg" alt="School Logo" class="school-logo" style="height: 80px; width: 80px; margin-right: 45px;">
                <h2 style="margin-top: 10px;">Login to Your Account</h2>
                <p>Enter your credentials to access the system.</p>
            </div>
             <?php if (isset($login_error)): ?>
                <div class="error"><?php echo $login_error; ?></div>
            <?php endif; ?>
            <?php if (isset($_GET['logged_out'])): ?>
                <div class="message">You have been successfully logged out.</div>
            <?php endif; ?>
            <?php if (isset($defaultAdminCreated)): ?>
                <div class="info-box"><?php echo $defaultAdminCreated; ?></div>
            <?php endif; ?>
            <form method="POST" action="?page=login">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" name="login" style="width: 100%;">Login</button>
            </form>
        </div>
    </div>
    <?php endif; ?>
    <!-- ALL ORIGINAL MODALS PRESERVED -->
    <div class="modal" id="restockModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Restock Item</h2>
                <button class="close-modal" onclick="closeRestockModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form method="POST">
                    <input type="hidden" name="restock_inventory_id" id="restock_inventory_id">
                    <div class="form-group">
                        <label>Item Name</label>
                        <input type="text" id="restock_item_name" readonly>
                    </div>
                    <div class="form-group">
                        <label for="restock_quantity">Quantity to Add</label>
                        <input type="number" id="restock_quantity" name="restock_quantity" min="1" required value="1">
                    </div>
                    <div class="form-group">
                        <label for="restock_price">New Price per Unit</label>
                        <input type="number" id="restock_price" name="restock_price" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="restock_date">Date of Restock</label>
                        <input type="date" id="restock_date" name="restock_date" required value="<?php echo date('Y-m-d'); ?>">
                    </div>
                    <!-- NEW: Information about unit generation -->
                    <div id="restockUnitInfo" class="info-box" style="display: none; margin-bottom: 15px; padding: 10px; font-size: 0.9rem;">
                        <strong>Note:</strong> For Non-Consumable items, individual units with unique property numbers will be automatically generated for the restocked quantity.
                    </div>
                    <!-- NEW: Transfer information for issued items -->
                    <div id="restockTransferInfo" class="info-box" style="display: none; margin-bottom: 15px; padding: 10px; font-size: 0.9rem;">
                        <strong>Note:</strong> This is an issued item. Restocking will transfer units from the main unissued inventory to this location.
                    </div>
                    <button type="submit" name="restock_item" class="btn-success">Confirm Restock</button>
                </form>
            </div>
        </div>
    </div>
    <div class="modal" id="returnModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Return Borrowed Item</h2>
                <button class="close-modal" onclick="closeReturnModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form method="POST">
                    <input type="hidden" name="borrowing_id" id="return_borrowing_id">
                    <div class="form-group">
                        <label>Item Name</label>
                        <input type="text" id="return_item_name" readonly>
                    </div>
                    <div class="form-group">
                        <label>Borrower</label>
                        <input type="text" id="return_borrower_name" readonly>
                    </div>
                    <div class="form-group">
                        <label for="actual_return_date">Return Date</label>
                        <input type="date" id="actual_return_date" name="actual_return_date" required value="<?php echo date('Y-m-d'); ?>">
                    </div>
                    <div class="form-group">
                        <label for="condition_after">Condition After Return</label>
                        <select id="condition_after" name="condition_after" required>
                            <option value="Excellent">Excellent</option>
                            <option value="Good" selected>Good</option>
                            <option value="Fair">Fair</option>
                            <option value="Poor">Poor</option>
                            <option value="Defective">Defective</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="return_status">Return Status</label>
                        <select id="return_status" name="return_status" required>
                            <option value="Returned">Returned</option>
                            <option value="Damaged">Damaged</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="damage_notes">Damage Notes</label>
                        <textarea id="damage_notes" name="damage_notes" placeholder="Describe any damage..."></textarea>
                    </div>
                    <button type="submit" name="return_item" class="btn-success">Process Return</button>
                </form>
            </div>
        </div>
    </div>
    <!-- NEW: Unit Functionality Check Modal -->
    <div class="modal" id="unitFunctionalityCheckModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Record Functionality Check</h2>
                <button class="close-modal" onclick="closeUnitFunctionalityCheckModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form method="POST">
                    <input type="hidden" name="unit_id" id="functionality_unit_id">
                    <div class="form-group">
                        <label>Property Number</label>
                        <input type="text" id="functionality_property_number" readonly>
                    </div>
                    <div class="form-group">
                        <label for="check_date">Check Date</label>
                        <input type="date" id="check_date" name="check_date" required value="<?php echo date('Y-m-d'); ?>">
                    </div>
                    <div class="form-group">
                        <label for="checked_by">Checked By</label>
                        <input type="text" id="checked_by" name="checked_by" required>
                    </div>
                    <div class="form-group">
                        <label for="functionality_status">Functionality</label>
                        <select id="functionality_status" name="functionality_status" required>
                            <option value="Fully Functional">Fully Functional</option>
                            <option value="Partially Functional">Partially Functional</option>
                            <option value="Needs Maintenance">Needs Maintenance</option>
                            <option value="Needs Replacement">Needs Replacement</option>
                            <option value="Not Functional">Not Functional</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="condition_status">Current Condition</label>
                        <select id="condition_status" name="condition_status" required>
                            <option value="Excellent">Excellent</option>
                            <option value="Good" selected>Good</option>
                            <option value="Fair">Fair</option>
                            <option value="Poor">Poor</option>
                            <option value="Defective">Defective</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="maintenance_required">Maintenance Notes</label>
                        <textarea id="maintenance_required" name="maintenance_required"></textarea>
                    </div>
                    <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="replacement_recommended" name="replacement_recommended" value="1" style="width: auto; height: 18px;">
                        <label for="replacement_recommended" style="margin: 0;">Replacement Recommended</label>
                    </div>
                    <div class="form-group">
                        <label for="estimated_maintenance_cost">Estimated Maintenance Cost (â‚±)</label>
                        <input type="number" id="estimated_maintenance_cost" name="estimated_maintenance_cost" min="0" step="0.01" value="0.00">
                    </div>
                    <div class="form-group">
                        <label for="next_check_date">Next Check Date</label>
                        <input type="date" id="next_check_date" name="next_check_date">
                    </div>
                    <div class="form-group">
                        <label for="notes">Additional Notes</label>
                        <textarea id="notes" name="notes"></textarea>
                    </div>
                    <div class="form-group">
                        <button type="submit" name="record_unit_functionality_check" class="btn-functionality">Record Check</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- NEW: Department Issue Modal (REMOVED - Now using the main form with quantity) -->
    <?php if (isset($_GET['view_history']) && $history_item): ?>
    <div class="modal" id="historyModal" style="display: flex;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>History: <?php echo htmlspecialchars($history_item['item_name']); ?></h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab(event, 'batch')">Batch History</div>
                    <div class="tab" onclick="switchTab(event, 'release')">Release History</div>
                    <div class="tab" onclick="switchTab(event, 'borrowing')">Borrowing History</div>
                </div>
           
                <div id="batch-tab" class="tab-content active">
                    <?php if (count($batch_history) > 0): ?>
                    <table class="history-table"><thead><tr><th>Date</th><th>Qty</th><th>Price</th><th>Notes</th></tr></thead><tbody>
                    <?php foreach ($batch_history as $batch): ?><tr><td><?php echo date('M j, Y', strtotime($batch['batch_date'])); ?></td><td><?php echo $batch['batch_quantity']; ?></td><td>â‚±<?php echo number_format($batch['batch_price'], 2); ?></td><td><?php echo htmlspecialchars($batch['notes']); ?></td></tr><?php endforeach; ?>
                    </tbody></table>
                    <?php else: ?><p class="no-history" style="text-align:center; padding: 20px;">No batch history available.</p><?php endif; ?>
                </div>
           
                <div id="release-tab" class="tab-content">
                    <?php if (count($release_history) > 0): ?>
                    <table class="history-table"><thead><tr><th>Date</th><th>Qty</th><th>Released To</th><th>Purpose</th></tr></thead><tbody>
                    <?php foreach ($release_history as $release): ?><tr><td><?php echo date('M j, Y', strtotime($release['release_date'])); ?></td><td><?php echo $release['release_quantity']; ?></td><td><?php echo htmlspecialchars($release['released_to']); ?></td><td><?php echo htmlspecialchars($release['purpose']); ?></td></tr><?php endforeach; ?>
                    </tbody></table>
                    <?php else: ?><p class="no-history" style="text-align:center; padding: 20px;">No release history available.</p><?php endif; ?>
                </div>
           
                <div id="borrowing-tab" class="tab-content">
                    <?php if (count($borrowing_history) > 0): ?>
                    <table class="history-table"><thead><tr><th>Borrower</th><th>Borrow Date</th><th>Return Date</th><th>Status</th></tr></thead><tbody>
                    <?php foreach ($borrowing_history as $borrow): ?><tr><td><?php echo htmlspecialchars($borrow['borrower_name']); ?></td><td><?php echo date('M j, Y', strtotime($borrow['borrow_date'])); ?></td><td><?php echo $borrow['actual_return_date'] ? date('M j, Y', strtotime($borrow['actual_return_date'])) : 'N/A'; ?></td><td><span class="status-badge status-<?php echo strtolower($borrow['status']); ?>"><?php echo $borrow['status']; ?></span></td></tr><?php endforeach; ?>
                    </tbody></table>
                    <?php else: ?><p class="no-history" style="text-align:center; padding: 20px;">No borrowing history available.</p><?php endif; ?>
                </div>
            </div>
        </div>
    </div>
    <?php endif; ?>
    <script>
        // NEW: Auto-close sidebar when navigation links are clicked on mobile devices
const sidebarLinks = document.querySelectorAll('.sidebar-nav-link');
sidebarLinks.forEach(link => {
    link.addEventListener('click', () => {
        // Check if it's a mobile device (screen width <= 768px)
        if (window.innerWidth <= 768) {
            sidebar.classList.remove('active');
            document.body.classList.remove('sidebar-open');
            localStorage.setItem('sidebarOpen', false);
        }
    });
});
        document.addEventListener('DOMContentLoaded', function() {
            // NEW: Sidebar Toggle Functionality
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const toggleLines = document.querySelectorAll('.toggle-line');
       
            if (sidebarToggle && sidebar) {
                // Load sidebar state from localStorage
                if (localStorage.getItem('sidebarOpen') === 'true') {
                    sidebar.classList.add('active');
                    document.body.classList.add('sidebar-open');
                }
       
                sidebarToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('active');
                    document.body.classList.toggle('sidebar-open');
                    localStorage.setItem('sidebarOpen', sidebar.classList.contains('active'));
                });
            }
       
            // Close sidebar when clicking outside
            document.addEventListener('click', (e) => {
                if (sidebar.classList.contains('active') &&
                    !sidebar.contains(e.target) &&
                    !sidebarToggle.contains(e.target)) {
                    sidebar.classList.remove('active');
                    document.body.classList.remove('sidebar-open');
                    localStorage.setItem('sidebarOpen', false);
                }
            });
            // Dark Mode
            const darkModeToggle = document.getElementById('sidebarDarkModeToggle');
            const body = document.body;
            if (localStorage.getItem('darkMode') === 'enabled') {
                body.classList.add('dark-mode');
            }
            if(darkModeToggle) {
                darkModeToggle.addEventListener('click', () => {
                    body.classList.toggle('dark-mode');
                    localStorage.setItem('darkMode', body.classList.contains('dark-mode') ? 'enabled' : 'disabled');
                });
            }
            // --- Location Field Logic for Department Issue ---
            function handleLocationChange(locationSelectId, subLocationClass) {
                const locationSelect = document.getElementById(locationSelectId);
                const subLocationFields = document.querySelectorAll('.' + subLocationClass);
                function toggleSubLocationFields() {
                    if (locationSelect.value === 'STII Main') {
                        subLocationFields.forEach(field => field.style.display = 'block');
                    } else {
                        subLocationFields.forEach(field => field.style.display = 'none');
                        // Optionally clear floor values when hiding
                         const floorSelect = document.getElementById('floor_number');
                         if (floorSelect) floorSelect.value = '';
                    }
                }
                if (locationSelect) {
                    locationSelect.addEventListener('change', toggleSubLocationFields);
                    // Initial check on page load
                    toggleSubLocationFields();
                }
            }
            // Apply to Department Issue form
            handleLocationChange('location', 'sub-location-fields');
            // NEW: Update available units when item selection changes
            const inventorySelect = document.getElementById('inventory_id');
            const quantityInput = document.getElementById('quantity');
            const availableUnitsSpan = document.getElementById('available_units');
            if (inventorySelect && quantityInput && availableUnitsSpan) {
                inventorySelect.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    const available = selectedOption.getAttribute('data-available');
                    availableUnitsSpan.textContent = available;
                    quantityInput.setAttribute('max', available);
               
                    // Reset quantity to 1 if it exceeds available
                    if (parseInt(quantityInput.value) > parseInt(available)) {
                        quantityInput.value = 1;
                    }
                });
                // Initialize on page load
                if (inventorySelect.value) {
                    const selectedOption = inventorySelect.options[inventorySelect.selectedIndex];
                    const available = selectedOption.getAttribute('data-available');
                    availableUnitsSpan.textContent = available;
                    quantityInput.setAttribute('max', available);
                }
            }
            // NEW: Report Form Location Logic
            const reportLocationSelect = document.getElementById('report_location');
            const reportFloorFieldGroup = document.getElementById('report-floor-field-group');
            function handleReportLocationChange() {
                if (reportLocationSelect && reportFloorFieldGroup) {
                    if (reportLocationSelect.value === 'STII Main') {
                        reportFloorFieldGroup.style.display = 'block';
                    } else {
                        reportFloorFieldGroup.style.display = 'none';
                        // Clear floor value when hiding
                        const reportFloorSelect = document.getElementById('report_floor_number');
                        if (reportFloorSelect) reportFloorSelect.value = '';
                    }
                }
            }
            if (reportLocationSelect) {
                reportLocationSelect.addEventListener('change', handleReportLocationChange);
                // Initial check on page load
                handleReportLocationChange();
            }
            // UPDATED: Inventory Page Location Filter Logic
            const inventoryLocationSelect = document.getElementById('location_filter');
            const inventoryFloorFilterGroup = document.getElementById('floor-filter-group');
            function handleInventoryLocationChange() {
                if (inventoryLocationSelect && inventoryFloorFilterGroup) {
                    if (inventoryLocationSelect.value === 'STII Main') {
                        inventoryFloorFilterGroup.style.display = 'block';
                    } else {
                        inventoryFloorFilterGroup.style.display = 'none';
                        // Clear floor value when hiding
                        const floorSelect = document.getElementById('floor_number');
                        if (floorSelect) floorSelect.value = '';
                    }
                }
            }
            if (inventoryLocationSelect) {
                inventoryLocationSelect.addEventListener('change', function() {
                    handleInventoryLocationChange();
                    // Submit form on change for mobile
                    if (window.innerWidth <= 768) {
                        this.form.submit();
                    }
                });
                // Initial check on page load
                handleInventoryLocationChange();
            }
            // Modals
            window.closeModal = function() {
                const url = new URL(window.location);
                url.searchParams.delete('view_history');
                window.history.pushState({}, '', url);
                document.getElementById('historyModal').style.display = 'none';
            };
       
            // UPDATED: Restock modal to show transfer info for issued items
            window.openRestockModal = (id, name, price, unit, itemType, isIssued) => {
                document.getElementById('restock_inventory_id').value = id;
                document.getElementById('restock_item_name').value = name + ' (' + unit + ')'; // Show unit
                document.getElementById('restock_price').value = parseFloat(price).toFixed(2);
           
                // NEW: Show/hide unit info based on item type
                const unitInfo = document.getElementById('restockUnitInfo');
                const transferInfo = document.getElementById('restockTransferInfo');
           
                if (itemType === 'Non-Consumable') {
                    unitInfo.style.display = 'block';
                } else {
                    unitInfo.style.display = 'none';
                }
           
                // NEW: Show transfer info for issued items
                if (isIssued === 'true') {
                    transferInfo.style.display = 'block';
                } else {
                    transferInfo.style.display = 'none';
                }
           
                document.getElementById('restockModal').style.display = 'flex';
            };
       
            window.closeRestockModal = () => { document.getElementById('restockModal').style.display = 'none'; };
            window.openReturnModal = (id, name, borrower) => {
                document.getElementById('return_borrowing_id').value = id;
                document.getElementById('return_item_name').value = name;
                document.getElementById('return_borrower_name').value = borrower;
                document.getElementById('returnModal').style.display = 'flex';
            };
            window.closeReturnModal = () => { document.getElementById('returnModal').style.display = 'none'; };
       
            // NEW: Unit Functionality Check Modal functions
            window.openUnitFunctionalityCheckModal = (unitId, propertyNumber) => {
                document.getElementById('functionality_unit_id').value = unitId;
                document.getElementById('functionality_property_number').value = propertyNumber;
                document.getElementById('unitFunctionalityCheckModal').style.display = 'flex';
            };
            window.closeUnitFunctionalityCheckModal = () => { document.getElementById('unitFunctionalityCheckModal').style.display = 'none'; };
       
            // NEW: View Unit Check History
            window.viewUnitCheckHistory = (unitId) => {
                // This could open a modal or navigate to a page showing the full check history for the unit
                // For now, we'll just alert that this feature is coming soon
                alert('Full check history view for this unit is coming soon!');
            };
            // Modal closing events
            document.addEventListener('click', e => {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                    if (e.target.id === 'historyModal') closeModal();
                }
            });
            document.addEventListener('keydown', e => { if (e.key === 'Escape') { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); if (document.getElementById('historyModal') && document.getElementById('historyModal').style.display !== 'none') closeModal(); } });
            // History Modal Tabs
            window.switchTab = (event, tabName) => {
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.getElementById(tabName + '-tab').classList.add('active');
                event.currentTarget.classList.add('active');
            };
            // Dynamic form updates
            const issueSelect = document.getElementById('issue_inventory_id');
            if(issueSelect) {
                issueSelect.addEventListener('change', function() {
                    const selected = this.options[this.selectedIndex];
                    const prop = selected.getAttribute('data-property');
                    document.getElementById('issue_property_number').value = prop || '';
                });
            }
       
            // Add Item form: Link item type to borrowable status
            const itemTypeSelect = document.getElementById('item_type');
            const isBorrowableCheckbox = document.getElementById('is_borrowable');
            if(itemTypeSelect && isBorrowableCheckbox) {
                itemTypeSelect.addEventListener('change', function() {
                    if (this.value === 'Consumable') {
                        isBorrowableCheckbox.checked = false;
                        isBorrowableCheckbox.disabled = true;
                    } else {
                        isBorrowableCheckbox.disabled = false;
                    }
                });
                // Initial check in case default is Consumable
                if (itemTypeSelect.value === 'Consumable') {
                     isBorrowableCheckbox.checked = false;
                     isBorrowableCheckbox.disabled = true;
                }
            }
            // Report form
            const reportForm = document.getElementById('reportForm');
            if(reportForm) {
                 // Auto-set dates
                const today = new Date().toISOString().split('T')[0];
                const firstDay = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
                const startDateInput = document.getElementById('report_start_date');
                const endDateInput = document.getElementById('report_end_date');
                 // Only set if not already set by GET param (important for viewing specific date ranges)
                if (!startDateInput.value) startDateInput.value = firstDay;
                if (!endDateInput.value) endDateInput.value = today;
                reportForm.addEventListener('submit', function(e) {
                    const action = document.activeElement.value;
                    if (action === 'view') {
                        e.preventDefault();
                        const params = new URLSearchParams(new FormData(this));
                        params.set('action', 'view');
                        window.open('?' + params.toString(), '_blank');
                    } else {
                        this.target = '_self';
                    }
                });
            }
            const expectedReturn = document.getElementById('expected_return_date');
            if (expectedReturn) {
                const nextWeek = new Date();
                nextWeek.setDate(nextWeek.getDate() + 7);
                // Only set default if not already set
                if (!expectedReturn.value) {
                    expectedReturn.value = nextWeek.toISOString().split('T')[0];
                }
            }
        });
    </script>
</body>
</html>
